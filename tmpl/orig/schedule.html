<!DOCTYPE html>
<html>
<head>
<%include file="header_inc_v4.html" />
<title>POSX - Schedule</title>

<script type="text/javascript">




$(function() {

g_v_tp_ctrl = $('.tp_ctrl');
idx_elements(g_v_tp_ctrl, 5);
var els = g_v_tp_ctrl.data('in_els');

els.btn_schedule[0].button().click(function() {
    var els = g_v_dlg_doc_form.data('in_els');
    els.date[0].val('');
    els.type[0].val('');
    els.num[0].val('');
    g_v_dlg_doc_form.data('pjs', null).dialog('open');
});

g_v_dlg_doc_form = $('#dlg_doc_form').dialog({
    autoOpen: false,
    width:500,
    height:420,
    buttons: {
        'schedule': function() {
            var pjs = g_v_dlg_doc_form.data('pjs');
            if(!pjs) return;
            
            var els = g_v_dlg_doc_form.data('in_els');
            var date = els.date[0].val();
            if(!date) return;
            
            post_js_ex('?fn=set_doc', {type:pjs.type, sid:pjs.sid, date:date, rev:pjs.sc_rev}, function(js) {
                //els.num[0].val('');
                //els.info[0].val('OK');
            });
            
        }
    }
});
idx_elements(g_v_dlg_doc_form, 4);
var els = g_v_dlg_doc_form.data('in_els');

var ts_doc_lku = null;
var ts_doc_lku_seq = 0;
els.num[0].keyup(function(evt) {
    var seq = ++ts_doc_lku_seq;
    
    var els = g_v_dlg_doc_form.data('pjs', null).data('in_els');
    els.info[0].val('');
    els.date[0].val('');
    
    var type = els.type[0].val();
    var num = $.trim(els.num[0].val());
    if(!num) return;
    
    if(ts_doc_lku) clearTimeout(ts_doc_lku);
    ts_doc_lku = setTimeout(function() {
        if(seq !== ts_doc_lku_seq) return;
        get_js_ex('?fn=get_doc', {type:type, num:num}, function(js) {
            if(seq !== ts_doc_lku_seq) return;
            
            var lst = [];
            
            if(js.company) lst.push(js.company + ' *By ' + js.assoc);
            lst.push('- DocDate: ' + fmt_date(js.doc_date));
            lst.push('- Amount: $' + js.total.toFixed(2));
            
            if(js.sc_rev) {
                var y,m,d;
                d = js.sc_date % 100;
                y = Math.floor(js.sc_date / 100);
                m = y % 100;
                y = Math.floor(y / 100);
                
                lst.push('- ScheduledDeliveryDate: ' + m + '/' + d + '/' + y);
            }
            
            g_v_dlg_doc_form.data('pjs', js);
            els.info[0].val(lst.join('\n'));
            
        }, function(t, args) {
            if(t === 1) els.info[0].val(args[0].err_s);
        });
        
    }, 500);
});

}); //ready

</script>

<style type="text/css">
.ui-widget {font-size:18px;}
.tp_ctrl {height:50px;line-height:50px;padding-left:10px;}
.tp_ctrl input, .tp_ctrl select {margin-right:10px;}

#dlg_doc_form input {width:294px}
#dlg_doc_form select {width:300px}
#dlg_doc_form textarea {width:90%;height:120px;margin-top:10px;}

</style>

</head>
<body>

<div class="tp_ctrl">
<select style="width:180px" name="ctrl_user"><option value="">-- All Sales --</option></select>
<input type="date" name="ctrl_date" />
<input type="button" name="ctrl_btn_schedule" value="schedule" />
</div>



<div id="dlg_doc_form" title="Schedule Form">
<div class="xlabel"><div>Type:</div><div><select name="doc_type"><option value="">SalesOrder</option><option value="1">Receipt</option></select></div></div>
<div class="xlabel"><div>Number:</div><div><input type="text" name="doc_num" /></div></div>
<div class="xlabel"><div>Delivery:</div><div><input type="date" name="doc_date" /></div></div>
<div style="text-align:center"><textarea name="doc_info" disabled="disabled"></textarea></div>
</div>

</body>
</html>
