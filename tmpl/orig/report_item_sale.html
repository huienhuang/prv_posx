<!DOCTYPE html>
<html>
<head>
<%include file="header_inc_v2.html" />
<title>POSX - Item - Report - Sale</title>

<script type="text/javascript">
<%
import json
%>
ITEM_L_DEPT = ${json.dumps(const.ITEM_L_DEPT)};
ITEM_D_CATE = ${json.dumps(const.ITEM_D_CATE)};

g_tg_item_list_data = {'frm_mon':'','to_mon':'', 'status':0, 'cate':'', 'dept':''};

function cate_apply()
{
    var els = g_v_ctrl.data('in_els');
    var dept = els.dept[0].val('');
    dept.children().slice(1).remove();
    
    var v = $(this).val();
    if(!v) {
        for(var i = 0; i < ITEM_L_DEPT.length; i++) dept.append( $('<option></option>').text(ITEM_L_DEPT[i][0]) );
    } else {
        var cate = ITEM_D_CATE[v] || [];
        for(var i = 0; i < cate.length; i++) dept.append( $('<option></option>').text(cate[i]) );
    }
    
    apply.call(this);
}

function apply()
{
    var els = g_v_ctrl.data('in_els');
    
    var status = els.status[0].val();
    var cate = els.cate[0].val();
    var dept = els.dept[0].val();
    var frm_mon = els.frm_mon[0].val().replace('-', '');
    var to_mon = els.to_mon[0].val().replace('-', '');
    
    g_tg_item_list_data.frm_mon = frm_mon;
    g_tg_item_list_data.to_mon = to_mon;
    g_tg_item_list_data.status = status;
    g_tg_item_list_data.cate = cate;
    g_tg_item_list_data.dept = dept;
    
    g_v_tg_item_list.tinygrid('update', -1, true, true, true);
}

function export_csv()
{
    var els = g_v_ctrl.data('in_els');
    var data = {
        'status': els.status[0].val(),
        'cate': els.cate[0].val(),
        'dept': els.dept[0].val(),
        'frm_mon': els.frm_mon[0].val().replace('-', ''),
        'to_mon': els.to_mon[0].val().replace('-', ''),
    };

    g_v_form_dl.find('input[name="js"]').val( JSON.stringify(data) );
    g_v_form_dl.submit();
}

$(function() {
    
$('.btn').button();

g_v_tg_item_list = $('.tg_item_list').tinygrid({
len:0,
src:{page:'reportitem?fn=get_items', data:g_tg_item_list_data},
cols: [{name:'ID', width:70},
       {name:'Name', width:"100%"},
       {name:'UOM', width:50},
       {name:'Status', width:120},
       {name:'Cate', width:110},
       {name:'Dept', width:200},
       {name:'OnHand', width:90},
       {name:'OnOrder', width:90},
       {name:'T_Qty', width:90},
       {name:'T_Sale', width:100},
       {name:'T_Cost', width:100},
       {name:'Margin', width:100},
       {name:'Margin%', width:90},
       ],
click: function(r, c, d) {
        window.open('hist?fn=itemhist&tid='+d[13],'posx_item_hist','location=0,width=992,height=700');
},
});

g_v_form_dl = $('#form_dl');

g_v_ctrl = $('.x_ctrl')
idx_elements(g_v_ctrl, 0);
var els = g_v_ctrl.data('in_els');
els.frm_mon[0].change(apply);
els.to_mon[0].change(apply);
els.status[0].change(apply);
els.dept[0].change(apply);
els.export[0].click(export_csv);
els.quit[0].click(go_home);
els.cate[0].change(cate_apply).change();


});


</script>

<style type="text/css">
.ui-widget {font-size:18px}
.x_ctrl > input {margin-right:10px}
</style>

</head>
<body>

<div class="x_ctrl">
<select name="status" style="width:130px">
<option value="0">- All -</option>
%for status in const.ITEM_L_STATUS:
<option value="${status[1]|h}">${status[0]|h}</option>
%endfor
</select>
<select name="cate" style="width:120px">
<option value="">- All -</option>
%for cate in const.ITEM_L_CATE:
<option>${cate[0]}</option>
%endfor
</select>
<select name="dept" style="width:140px"><option value="">- All -</option></select>
<input type="month" name="frm_mon" title="From" style="width:200px" />
<input type="month" name="to_mon" title="To" style="width:200px" />
<input type="button" name="export" value="export" class="btn" />
<input type="button" name="quit" value="quit" class="btn" />
</div>

<div class="x_body tg_item_list"></div>

<form id="form_dl" target="_blank" action="?fn=export_csv" method="post" style="display:none">
<input type="hidden" name="js" />
</form>

</body>
</html>
