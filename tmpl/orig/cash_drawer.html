<!DOCTYPE html>
<html>
<head>
<%include file="header_inc_v3.html" />
<title>POSX - Cash Drawer</title>

<script type="text/javascript">
function load_media()
{
    var lst = g_v_dlg_drawer_count.data('lst');
    var sum = 0;
    for(var i = 0; i < g_v_media_qty_ins.length; i++) {
        var cd = $(g_v_media_qty_ins[i]);
        var lbl = cd.parent().prev().text();
        if(lbl[0] !== '$') continue;
        var val = parseFloat(lbl.split(' ')[0].substr(1));
        var qty = lst[val.toFixed(2)] || 0;
        if(qty < 0) qty = 0;
        var ttl = val * qty;
        
        cd.val(qty || '');
        cd.next('input').val(qty ? ttl.toFixed(2) : '');
        
        sum += ttl;
    }
    
    lst['sum'] = sum;
    g_v_dlg_media.find('.media_total').val( sum.toFixed(2) );
}

function media_qty_chg()
{
    var lst = g_v_dlg_drawer_count.data('lst');
    var cd = $(this);
    var lbl = cd.parent().prev().text();
    if(lbl[0] === '$') {
        var val = parseFloat(lbl.split(' ')[0].substr(1));
        var qty = parseFloat(cd.val()) || 0.0;
        var sal = val.toFixed(2);
        if(qty < 0) qty = 0;
        
        var old_ttl = (lst[sal] || 0) * val;
        lst[sal] = qty;
        var new_ttl = val * qty;
        lst['sum'] -= old_ttl - new_ttl;
        
        cd.next('input').val( qty ? new_ttl.toFixed(2) : '' );
    }
    
    g_v_dlg_media.find('.media_total').val( lst.sum.toFixed(2) );
}

function dc_station_chg()
{
    var station = parseInt( $(this).val() ) || 0;
    var status = $('.drawer_status', g_v_dlg_drawer_count).empty();
    if(!station) return;
    
    get_js('?fn=get_total_by_station', {'station': station}, function(js) {
        status.empty()
        .append( $('<div></div>').text('cash: $' + js[0][0].toFixed(2) + ' (' + js[0][1] + '), check: $' + js[1][0].toFixed(2) + ' (' + js[1][1] + ')') );
    });
}


function dc_save()
{
    var els = g_v_dlg_drawer_count.data('in_els');
    var station = parseInt( els.station[0].val() ) || 0;
    var begin_amt = parseFloat( els.begin[0].val() ) || 0;
    var count_amt = parseFloat( els.count[0].val() ) || 0;
    var check_amt = parseFloat( els.check[0].val() ) || 0;
    if(!station) return;
    var reason = g_v_dlg_drawer_unmatched.data('in_els').reason[0].val();
    
    post_js('?fn=save',
    {'station': station, 'begin_amt': begin_amt, 'count_amt': count_amt, 'check_amt': check_amt, 'reason': reason},
    function(js) {
        if(js.ret) {
            var in_els = g_v_dlg_drawer_unmatched.data('in_els');
            in_els.error[0].val(js.err_amt.toFixed(2));
            g_v_dlg_drawer_unmatched.dialog('open');
        } else {
            g_v_dlg_drawer_count.dialog('close');
            g_v_dc_lst.tinygrid('update', -1, true, true, true);
        }
    });
    
}

$(function() {

$('.btn').button();
$('.tp_ctrl input[value="Quit"]').click(go_home);
$('.tp_ctrl input[value="Report"]').click(function() {
    window.open('?fn=report','posx_print_wnd','location=0,width=992,height=700');
});
$('.tp_ctrl input[value="Drawer Count"]').click(function() {
    var els = g_v_dlg_drawer_count.data('in_els');
    els.station[0].val('').change();
    els.begin[0].val('');
    els.count[0].val('');
    els.check[0].val('');
    g_v_dlg_drawer_count.data('lst', {}).dialog('open');
});

g_v_dlg_drawer_unmatched = $('#dlg_drawer_unmatched').dialog({
    autoOpen: false,
    modal: true,
    width:480,
    height:250,
    buttons: {
        'save': function() { g_v_dlg_drawer_unmatched.dialog('close'); dc_save(); }
    }
});
idx_elements(g_v_dlg_drawer_unmatched, 5);

g_v_dlg_drawer_count = $('#dlg_drawer_count').dialog({
    autoOpen: false,
    modal: true,
    width:480,
    height:370,
    close: function(event, ui) {
        g_v_dlg_drawer_count.data('lst', undefined);
    },
    buttons: {
        'save': function() { g_v_dlg_drawer_unmatched.data('in_els').reason[0].val(''); dc_save(); }
    }
});
$('input[value="Media"]', g_v_dlg_drawer_count).click(function() {
    load_media();
    g_v_dlg_media.dialog('open');
});
idx_elements(g_v_dlg_drawer_count, 3);
g_v_dlg_drawer_count.data('in_els').station[0].change(dc_station_chg);

g_v_dlg_media = $('#dlg_media').dialog({
    autoOpen: false,
    modal: true,
    width:400,
    height:570,
    close: function(event, ui) {
        g_v_dlg_drawer_count.data('in_els').count[0].val( g_v_dlg_drawer_count.data('lst').sum.toFixed(2) );
    }
});
g_v_media_qty_ins = g_v_dlg_media.find('.xlabel input:nth-child(1)').change(media_qty_chg);


g_v_dlg_drawer_log = $('#dlg_drawer_log').dialog({
    autoOpen: false,
    width:460,
    height:200,
});


g_v_dc_lst = $('#dc_lst').tinygrid({
len:1,
src:{page:'?fn=get_lst'},
cols: [{name:'RID', width:100},
       {name:'Station', width:100},
       {name:'Error', width:"100%"},
       {name:'Date', width:200},
       ],
click: function(r, c, d) {
    var js = d[4];
    g_v_dlg_drawer_log.dialog('option', 'title', 'RID#' + d[0] + ' - Station#' + d[1] + ' - ' + d[3]).dialog('open');
    g_v_dlg_drawer_log.empty()
    .append($('<div></div>').text('begin: $' + js.begin.toFixed(2)))
    .append($('<div></div>').text('cash: $' + js.cash.toFixed(2) + '  vs $' + js.total[0][0].toFixed(2) + ' (' + js.total[0][1] + ')'))
    .append($('<div></div>').text('check: $' + js.check.toFixed(2) + ' vs $' + js.total[1][0].toFixed(2) + ' (' + js.total[1][1] + ')'))
    .append($('<div></div>').text('result: ' + (d[2] ? 'error: ' + d[2] : 'ok')));
}
});


});


</script>

<style type="text/css">
.ui-widget {font-size:18px;}

.tp_ctrl {height:50px;line-height:50px;padding-left:10px;}
.tp_ctrl input, .tp_ctrl select {margin-right:10px;}

#dc_lst {top:50px}

#dlg_media .xlabel input:nth-child(1) {width:60px}
#dlg_media .xlabel input:nth-child(2) {width:100px}

#dlg_drawer_count .drawer_status {border:1px solid #ccc;background-color:#f8f8f8;height:30px;line-height:30px;font-weight:bold;text-align:center}

#dlg_drawer_log {background-color:#fafafa}

</style>

</head>
<body>

<div class="tp_ctrl">
<input type="button" value="Drawer Count" class="btn" />
<input type="button" value="Report" class="btn" />
<input type="button" value="Quit" class="btn" style="float:right;margin-top:9px" />
</div>
<div id="dc_lst">

</div>

<div id="dlg_drawer_count" title="Drawer Count">
<div class="xlabel"><div>Station #</div><div><select name="dc_station" style="width:190px"><option value="">-</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div></div>
<div class="drawer_status"></div>
<div class="xlabel"><div>Begin $</div><div><input type="text" name="dc_begin" /></div></div>
<div class="xlabel"><div>Cash $</div><div><input type="text" name="dc_count" /> <input type="button" value="Media" class="btn" name="dc_btn_media" /></div></div>
<div class="xlabel"><div>Check $</div><div><input type="text" name="dc_check" /></div></div>
</div>

<div id="dlg_media" title="Media">
<div class="xlabel"><div>$100 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$50 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$20 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$10 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$5 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$1 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$0.50 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$0.25 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$0.10 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$0.05 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>$0.01 X</div><div><input type="text" /> = <input type="text" disabled="disabled" /></div></div>
<div class="xlabel"><div>Total</div><div><input type="text" style="visibility:hidden" /> = <input type="text" disabled="disabled" class="media_total" /></div></div>
</div>

<div id="dlg_drawer_unmatched" title="Unmatched">
<div class="xlabel"><div>Error $</div><div><input type="text" name="dcum_error" disabled="disabled" /></div></div>
<div class="xlabel"><div>Reason:</div><div><input type="text" name="dcum_reason" /></div></div>
</div>

<div id="dlg_drawer_log" title="Log"></div>


</body>
</html>