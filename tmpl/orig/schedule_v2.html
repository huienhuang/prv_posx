<!DOCTYPE html>
<html>
<head>
<%include file="header_inc_v4.html" />
<title>POSX - Schedule V2</title>

<script type="text/javascript">
g_last_upd_seq = ${sc_upd_seq};
g_map_wnd = null;

function load_map(dt)
{
    if(!g_map_wnd || !g_map_wnd.window || !g_map_wnd.window.load_doc_lst) {
        g_map_wnd = window.open('?fn=map&dt=' + dt,'posx_schedule_map','location=0');
    } else {
        g_map_wnd.window.load_doc_lst(dt, -1, 0);
    }
}

function load_doc(i, auto_print)
{
    g_v_dd_doc_viewer.attr('src', 'about:blank')

    var js = g_v_dlg_documents.data('jsd');
    if(!js || !js.lst[i]) return;
    var r = js.lst[i];
    
    js.cur_sel = i;
    g_v_dd_doc_viewer.attr('src', '?fn=print&view_only=1&sc_ids='+r.sc_id);
}

function load_doc_lst(dt, zidx, reload, auto_print)
{
    var o_sc_id = 0;
    var pre_sel = {};
    if(reload) {
        var o_jsd = g_v_dlg_documents.data('jsd');
        if(!o_jsd) return;
        dt = o_jsd.date;
        zidx = o_jsd.zone_id;
        if(o_jsd.cur_sel !== undefined) {
            var o_r = o_jsd.lst[o_jsd.cur_sel];
            o_sc_id = o_r.sc_id;
        }
        var cbs = o_jsd.v_cbs.filter(':checked');
        for(var i = 0; i < cbs.length; i++) pre_sel[ o_jsd.lst[ parseInt($(cbs[i]).val()) ].sc_id ] = 1;
        
    } else
        g_v_dd_doc_lst_body.empty();
    
    g_v_dd_doc_viewer.attr('src', 'about:blank');
    g_v_dlg_documents.data('jsd', null).dialog('option', 'title', 'Loading ...');
    g_v_dlg_documents.dialog('isOpen') || g_v_dlg_documents.dialog('open');
    
    get_js_ex('?fn=get_docs', {dt: dt, zone_id: zidx, 'clerk_id': g_v_tp_ctrl.data('in_els').user[0].val()}, function(js) {
        g_v_dlg_documents.data('jsd', js).dialog('option', 'title', int2date_s(js.date) + ' - ' + js.zone_nz + (js.state ? js.state == 1 ? ' - Open' : ' - Close' : ''));
        
        var dc = 0;
        var k = -1;
        var lst = [];
        for(var i = 0; i < js.lst.length; i++) {
            var r = js.lst[i];
            if(k < 0 && reload && o_sc_id === r.sc_id) k = i;
            dc += r.delivery_count ? 1 : 0;
            
            var cls = '';
            if(r.sc_flag & ${REC_FLAG_CANCELLING}) cls = ' doc_cancelling';
            else if(r.sc_flag & ${REC_FLAG_RESCHEDULED}) cls = ' doc_rescheduled';
            else if(r.sc_flag & ${REC_FLAG_PARTIAL_CHANGED}) cls = ' doc_partial_changed';
            else if(r.sc_flag & ${REC_FLAG_CHANGED}) cls = ' doc_changed';
            else if(r.sc_flag & ${REC_FLAG_ACCEPTED}) cls = ' doc_accepted';
            else cls = ' doc_pending';
            
            var vd = [];
            for(var j = 0; j < r.dr.length; j++) {
                var d = r.dr[j];
                if(r.doc_type)
                    vd.push( $('<div class="delivered_'+d[1]+'" onclick="open_wnd_receipt('+r.num+')"></div>').text('#' + (j + 1) + ' - ' + (d[1] ? 'Delivered' : 'Out for Delivery')) );
                else
                    vd.push( $('<div class="delivered_'+d[1]+'" onclick="open_wnd_receipt('+d[2]+')"></div>').text('#' + (j + 1) + ' - ' + (d[1] ? 'Delivered' : 'Out for Delivery')) );
            }
            var sflag = '';
            if(r.sc_flag & ${REC_FLAG_PARTIAL}) sflag += r.sc_flag & ${REC_FLAG_ACCEPTED} ? 'p' : 'P';
            if(r.sc_note_len) sflag += 'N';
            if(r.doc_dup > 1) sflag += 'D' + r.doc_dup;
            var v = $('<div class="prntbl_row'+cls+'"'+(r.sc_flag & ${REC_FLAG_ACCEPTED} ? ' title="Accepted"' : '')+'></div>')
            .append( $('<div><input type="checkbox" value="'+i+'"'+(reload && pre_sel[r.sc_id] ? ' checked="checked"': '')+' /></div>') )
            .append( $('<div onclick="load_doc('+i+')"></div>').text(r.num + (r.sc_flag & ${REC_FLAG_R_RESCHEDULED} ? '*' : '')) )
            .append( $('<div'+(r.delivery_count ? ' class="doc_in_delivery_log"' : '')+' onclick="open_wnd_cust(\''+r.cid+'\')"></div>').text(r.cust_nz) )
            .append( $('<div></div>').text(r.doc_amt.toFixed(2)) )
            .append( $('<div></div>').text(sflag) )
            .append( $('<div></div>').append(vd) );
            if(vd.length > 1) v.height( 30 * vd.length );
            lst.push(v);
        }
        if(reload) {
            var cs = g_v_dd_doc_lst_body.children();
            g_v_dd_doc_lst_body.prepend(lst);
            $(cs).remove();
        } else 
            g_v_dd_doc_lst_body.append(lst);
        
        g_v_dd_doc_lst_ftr.text('Total: ' + js.lst.length + ', Fill: ' + dc);
        js.v_cbs = g_v_dd_doc_lst_body.find('input[type="checkbox"]');
        reload && k >= 0 && load_doc(k, auto_print);
        
    }, undefined, undefined, undefined, '__load_doc_lst__');
    
}

function new_schedule_with_preset_date(di)
{
    var els = g_v_dlg_doc_form.data('in_els');
    els.num[0].val('');
    g_v_dlg_doc_form.dialog('open').data('preset_date', di).dialog('option', 'title', 'Schedule - PresetDate ' + int2date_s(di));
    load_doc_schedule();
    els.num[0].focus();
}

function load_overview_cb(js)
{
    g_v_t_top_hdr.empty();
    //g_v_t_left_hdr.empty();
    
    var ocs = g_v_t_body.children();
    
    var dt = js.dt;
    var zones = js.zones;
    
    var l_o = [];
    for(var i = 0; i < zones.length; i++) {
        var o = $('<div class="t_row"></div>');
        l_o.push(o);
        var l_oo = [];
        var zf = zones[i][1];
        for(var j = 0; j < dt.length; j++) {
            var dtj = dt[j];
            var z = (dtj[1] || [])[i];
            
            var zfd = zf[j];
            var s_cls = null;
            if(zfd === 1)
                s_cls = ' class="dd_open"';
            else if(zfd === -1)
                s_cls = ' class="dd_close"';
                
            var oo = $('<div'+(s_cls || '')+' onclick="load_doc_lst('+dtj[3]+','+(i-1)+')">&nbsp;</div>');
            l_oo.push(oo);
            if(z) {
                if(z[0]) oo.append( $('<div class="ovc_default ovc_pending"></div>').text(z[0]) );
                if(z[1]) oo.append( $('<div class="ovc_default ovc_accepted"></div>').text(z[1]) );
                if(z[3]) oo.append( $('<div class="ovc_default ovc_cancelling"></div>').text(z[3]) );
                if(z[2]) oo.append( $('<div class="ovc_default ovc_rescheduled"></div>').text(z[2]) );
                if(z[4]) oo.append( $('<div class="ovc_default ovc_changed"></div>').text(z[4]) );
                if(z[5]) oo.append( $('<div class="ovc_default ovc_partial_changed"></div>').text(z[5]) );
            }
        }
        o.append(l_oo);
    }
    g_v_t_body.prepend(l_o);
    $(ocs).remove();
    
    var l_o = [];
    for(var j = 0; j < dt.length; j++) {
        l_o.push( $('<div></div>')
                 .append($('<span title="Show Map" onclick="return load_map('+dt[j][3]+')"></span>').text(dt[j][0]))
                 .append($('<img title="New Schedule" src="img/add_new.png" alt="" border="0" onclick="return new_schedule_with_preset_date('+dt[j][3]+')" />'))
        );
    }
    g_v_t_top_hdr.append( $('<div class="t_row"></div>').append(l_o) );
    
}

function load_overview()
{
    get_js_ex('?fn=get_overview', {clerk_id: g_v_tp_ctrl.data('in_els').user[0].val()}, load_overview_cb,
              undefined, undefined, undefined, '__load_overview__');
}

function int2date_s(i)
{
    var s = i + '';
    return s.substr(s.length - 4, 2) + '/' + s.substr(s.length - 2, 2) + '/' + s.substr(0, s.length - 4);
}

function get_selected_docs()
{
    var lst = [];
    var js = g_v_dlg_documents.data('jsd');
    if(!js) return lst;
    
    var cbs = js.v_cbs.filter(':checked');
    for(var i = 0; i < cbs.length; i++) lst.push( js.lst[ parseInt($(cbs[i]).val()) ] );
    
    if(!lst.length && js.cur_sel !== undefined && js.lst[js.cur_sel]) lst.push(js.lst[js.cur_sel]);
    
    return lst;
}

function open_wnd_cust(cid)
{
    open_wnd('hist?fn=custhist&dg_type=5&cid='+cid,'posx_customer_hist');
}

function open_wnd_receipt(num)
{
    open_wnd('hist?fn=printreceipt&rno=' + num,'posx_print_wnd');
}

function chg__item_list_cb(i)
{
    var js = g_v_dlg_doc_form.data('pjs');
    if(!js) return;
    
    var v_com = js.v_com_lst[i];
    var qty = v_com[0].prop('checked') && js.ijs[i].qty || 0;
    v_com[1].val(qty || '');
    v_com[1].css('background-color', qty ? (qty === js.ijs[i].qty ? '#d4f0c2' : '#cae4ff') : '#faf7c9');
}

function chg__item_list_in(i)
{
    var js = g_v_dlg_doc_form.data('pjs');
    if(!js) return;
    var v_com = js.v_com_lst[i];
    var qty = parseInt(v_com[1].val()) || 0;
    v_com[1].val(qty || '');
    v_com[0].prop('checked', !!qty);
    
    v_com[1].css('background-color', qty ? (qty === js.ijs[i].qty ? '#d4f0c2' : '#cae4ff') : '#faf7c9');
}

function get_item_possible_match_content()
{
    var pm = $(this).data('possible_match');
    if(!pm) return null;

    var m = pm.v[1];
    var s = [];
    for(var i = 0; i < m.length; i++) s.push( '> ' + m[i][1] + ' / ' + m[i][0] );
    return $('<div class="p_item_pm"></div>').text('Possible Match:\n' + s.join('\n'));
}

$(function() {

g_v_dlg_doc_del = $('#dlg_doc_del').dialog({
    modal: true,
    autoOpen: false,
    width:300,
    height:200,
    buttons: {
        'No': function() { g_v_dlg_doc_del.dialog('close'); },
        'Yes': function() {
            g_v_dlg_doc_del.dialog('close');
            
            var pjs = g_v_dlg_doc_form.data('pjs');
            if(!pjs) return;
                
            var els = g_v_dlg_doc_form.data('in_els');
            var ridx = els.rec[0].val();
            var rec = ridx ? pjs.recs[ parseInt(ridx) ] : null;
            if(!rec) return;
                
            if(rec.sc_flag & ${REC_FLAG_CANCELLING}) return;
                
            post_js_ex('?fn=del_rec', {sc_id: rec.sc_id}, function() {
                if( g_v_dlg_documents.dialog('isOpen') ) load_doc_lst(0, 0, 1, 0);
                if( g_v_dlg_doc_form.dialog('isOpen') ) load_doc_schedule();
            });
        }
    }
});

g_v_dlg_documents = $('#dlg_documents').dialog({
    autoOpen: false,
    width:1320,
    height:650,
    buttons: [
%if has_perm_delivery_mgr:
        {
            text: '开放/关闭 此区',
            id: "dd_btn_close",
            click: function() {
                var js = g_v_dlg_documents.data('jsd');
                if(!js || js.zone_id < 1) return;
                
                post_js_ex('?fn=set_zone_state', {date:js.date, zidx:js.zone_id, state:js.state <= 0 ? 1 : -1}, function() {
                    load_doc_lst(0, 0, 1, 0);
                });
            },
        },
        {
            text: '清除标志',
            id: "dd_btn_clear",
            click: function() {
                var lst = get_selected_docs();
                var sc_ids = [];
                for(var i = 0; i < lst.length; i++) {
                    var r = lst[i];
                    if(r.sc_flag & ${REC_FLAG_CHANGED}) sc_ids.push(r.sc_id);
                }
                if(!sc_ids.length) return;
                
                post_js_ex('?fn=clear_cflag', {sc_ids: sc_ids.join('|')}, function(js) {
                    if(js.i_warning_s) MsgBox('Warning', js.i_warning_s);
                    load_doc_lst(0, 0, 1, 0);
                });
                
            },
        },
        {
            text: '同意更改',
            id: "dd_btn_change",
            click: function() {
                var lst = get_selected_docs();
                var sc_ids = [];
                for(var i = 0; i < lst.length; i++) {
                    var r = lst[i];
                    if(r.sc_flag & ${REC_FLAG_RESCHEDULED}) sc_ids.push(r.sc_id);
                }
                if(!sc_ids.length) return;
                
                post_js_ex('?fn=confirm_rescheduling', {sc_ids: sc_ids.join('|')}, function(js) {
                    if(js.i_warning_s) MsgBox('Warning', js.i_warning_s);
                    load_doc_lst(0, 0, 1, 0);
                });
                
            },
        },
        {
            text: '同意取消',
            id: "dd_btn_cancel",
            click: function() {
                var lst = get_selected_docs();
                var sc_ids = [];
                for(var i = 0; i < lst.length; i++) {
                    var r = lst[i];
                    if(r.sc_flag & ${REC_FLAG_CANCELLING}) sc_ids.push(r.sc_id);
                }
                if(!sc_ids.length) return;
                
                post_js_ex('?fn=del', {sc_ids: sc_ids.join('|')}, function(js) {
                    if(js.i_warning_s) MsgBox('Warning', js.i_warning_s);
                    load_doc_lst(0, 0, 1, 0);
                });
                
            },
        },
        
        {
            text: '打印',
            id: "dd_btn_print",
            click: function() {
                var lst = get_selected_docs();
                var sc_ids = [];
                for(var i = 0; i < lst.length; i++) {
                    var r = lst[i];
                    sc_ids.push(r.sc_id);
                }
                if(!sc_ids.length) return;
                
                window.open('?fn=print&auto_print=1&sc_ids=' + sc_ids.join('|'),'posx_batch_print','location=0');
            },
        },
        
        {
            text: '接受',
            id: "dd_btn_accept",
            click: function() {
                var lst = get_selected_docs();
                var sc_ids = [];
                for(var i = 0; i < lst.length; i++) {
                    var r = lst[i];
                    if(!(r.sc_flag & ${REC_FLAG_ACCEPTED})) sc_ids.push(r.sc_id);
                }
                if(!sc_ids.length) return;
                
                post_js_ex('?fn=accept', {sc_ids: sc_ids.join('|')}, function(js) {
                    if(js.i_warning_s) MsgBox('Warning', js.i_warning_s);
                    load_doc_lst(0, 0, 1, 0);
                });
                
            },
        },
        
        {
            text: '接受 & 打印',
            id: "dd_btn_accept_n_print",
            click: function() {
                var lst = get_selected_docs();
                var sc_ids = [];
                for(var i = 0; i < lst.length; i++) {
                    var r = lst[i];
                    if(!(r.sc_flag & ${REC_FLAG_ACCEPTED})) sc_ids.push(r.sc_id);
                }
                if(!sc_ids.length) return;
                
                post_js_ex('?fn=accept', {sc_ids: sc_ids.join('|')}, function(js) {
                    if(js.i_warning_s) MsgBox('Warning', js.i_warning_s);
                    load_doc_lst(0, 0, 1, 0);
                    window.open('?fn=print&auto_print=1&sc_ids=' + sc_ids.join('|'),'posx_batch_print','location=0');
                }, undefined, 1);
                
            },
        },
%endif
        {
            text: 'Schedule',
            id: "dd_btn_schedule",
            click: function() {
                var lst = get_selected_docs();
                if(!lst.length || lst.length > 1) return;
                var r = lst[0];
                var els = g_v_dlg_doc_form.data('in_els');
                els.num[0].val(r.num);
                els.type[0].val(r.doc_type ? '1' : '');
                g_v_dlg_doc_form.dialog('open');
                load_doc_schedule(r.sc_id);
            },
        },
    ]

});
/*
$('.doc_lst >.prntbl_row_hdr', g_v_dlg_documents).click(function() {
    load_doc_lst(0, 0, 1, 0);
});
*/
$('.doc_lst >.prntbl_row_hdr input[type="checkbox"]').change(function() {
    g_v_dd_doc_lst_body.find('input[type="checkbox"]').prop('checked', $(this).prop('checked'));
});
g_v_dd_doc_lst_filter = $('.doc_lst_filter', g_v_dlg_documents);
g_v_dd_doc_lst_body = $('.doc_lst >.prntbl_cnt', g_v_dlg_documents);
g_v_dd_doc_lst_ftr = $('.doc_lst >.prntbl_row_ftr >div', g_v_dlg_documents);
g_v_dd_doc_viewer = $('iframe', g_v_dlg_documents);

g_v_dlg_doc_form = $('#dlg_doc_form').dialog({
    modal: true,
    autoOpen: false,
    width:1070,
    height:600,
    open: function() {
        g_v_dlg_doc_form.data('preset_date', null).dialog('option', 'title', 'Schedule');
    },
    buttons: [
        {
            text: 'Confirm Rescheduling',
            id: "df_btn_confirm_rescheduling",
            click: function() {
                var pjs = g_v_dlg_doc_form.data('pjs');
                if(!pjs) return;
                
                var els = g_v_dlg_doc_form.data('in_els');
                var ridx = els.rec[0].val();
                if(!ridx) return;
                var rec = pjs.recs[ parseInt(ridx) ];
                if(!rec) return;
                
                post_js_ex('?fn=confirm_rescheduling', {sc_ids: rec.sc_id}, function(js) {
                    if( g_v_dlg_documents.dialog('isOpen') ) load_doc_lst(0, 0, 1, 0);
                    if( g_v_dlg_doc_form.dialog('isOpen') ) load_doc_schedule(rec.sc_id);
                });
            },
        },
        {
            text: 'Delete',
            id: "df_btn_cancel",
            click: function() { g_v_dlg_doc_del.dialog('open'); },
            
        },
        {
            text: 'Save',
            id: "df_btn_save",
            click: function() {
                var pjs = g_v_dlg_doc_form.data('pjs');
                if(!pjs) return;
                
                var els = g_v_dlg_doc_form.data('in_els');
                var note = els.note[0].val();
                var prio = els.prio[0].val();
                var date = els.date[0].val();
                var mode = parseInt(els.mode[0].val());
                var check_n_confirm = 0;
                if(!date) return;
                
                var ridx = els.rec[0].val();
                var rec = ridx ? pjs.recs[ parseInt(ridx) ] : {};
                
                var ijs = [];
                var doc = null;
                if(mode) {
                    check_n_confirm = $(g_v_df_item_lst_ftr_c[0]).children('input').prop('checked') ? 1 : 0;
                    if(ridx && rec.sc_flag & ${REC_FLAG_PARTIAL} && pjs.crc !== rec.doc_crc && !check_n_confirm) {
                        MsgBox('Warning - Please Check And Confirm!', 'Document Changed! Please Make Sure That Everything Is Correct!');
                        return;
                    }
                    var o_ijs = pjs.ijs;
                    for(var i = 0; i < o_ijs.length; i++) {
                        var t = o_ijs[i];
                        var r = [t.sid, 0];
                        var v_com = pjs.v_com_lst[i];
                        if(v_com[0].prop('checked')) r[1] = parseInt(v_com[1].val()) || 0;
                        if(t.qty * r[1] < 0 || Math.abs(r[1]) > Math.abs(t.qty)) {
                            MsgBox('Invalid Qty', 'Line #' + (i + 1) + ' - ItemNo - ' + t.num);
                            return;
                        }
                        ijs.push(r);
                    }
                    doc = JSON.stringify([pjs.crc, ijs])
                }
                
                post_js_ex('?fn=set_doc', {
                    type: pjs.type,
                    sid: pjs.sid,
                    sc_id: rec.sc_id,
                    prio: prio,
                    date: date,
                    note: note,
                    rev: rec.sc_rev,
                    doc: doc,
                    mode: mode,
                    check_n_confirm: check_n_confirm
                    }, function(js) {
                    if( g_v_dlg_documents.dialog('isOpen') ) load_doc_lst(0, 0, 1, 0);
                    if( g_v_dlg_doc_form.dialog('isOpen') ) load_doc_schedule(js.sc_id);
                });
            }
        }
    ],
});
g_v_df_item_lst_cnt = g_v_dlg_doc_form.find('.item_lst .prntbl_cnt');
g_v_df_item_lst_ftr_c = g_v_dlg_doc_form.find('.item_lst .prntbl_row_ftr').children();

idx_elements(g_v_dlg_doc_form, 4);
g_v_dlg_doc_form_btns = {
    'cancel': $('#df_btn_cancel'),
    'save': $('#df_btn_save'),
    'confirm_rescheduling': $('#df_btn_confirm_rescheduling'),
};
var els = g_v_dlg_doc_form.data('in_els');

els.date[0].datepicker({minDate: '+0d'});

els.rec[0].change(function() {
    var els = g_v_dlg_doc_form.data('in_els');
    var v = $(this).val();
    if(!v) {
        g_v_dlg_doc_form_btns.cancel.hide();
        g_v_dlg_doc_form_btns.confirm_rescheduling.hide();
        els.date[0].val('');
        els.prio[0].val('0');
        els.note[0].val('');
        els.mode[0].val('0').change();
        
        var pjs = g_v_dlg_doc_form.data('pjs');
        if(pjs && pjs.recs.length) MsgBox('Warning', 'Records Already Exists!');

        return;
    }
    var pjs = g_v_dlg_doc_form.data('pjs');
    var rec = pjs.recs[ parseInt(v) ];
    
    els.date[0].val(int2date_s(rec.sc_date));
    els.note[0].val(rec.sc_note);
    els.prio[0].val(rec.sc_prio + '');
    els.mode[0].val(rec.sc_flag & ${REC_FLAG_PARTIAL} ? '1' : '0').change();
    
    if(rec.sc_flag & ${REC_FLAG_CANCELLING})
        g_v_dlg_doc_form_btns.cancel.hide();
    else
        g_v_dlg_doc_form_btns.cancel.show();
        
    if(rec.sc_flag & ${REC_FLAG_RESCHEDULED})
        g_v_dlg_doc_form_btns.confirm_rescheduling.show();
    else
        g_v_dlg_doc_form_btns.confirm_rescheduling.hide();
        
});

els.mode[0].change(function() {
    $(g_v_df_item_lst_ftr_c[0]).children('input').prop('checked', false);
    g_v_df_item_lst_ftr_c.hide();
    
    var js = g_v_dlg_doc_form.data('pjs');
    if(!js) return;
    
    var els = g_v_dlg_doc_form.data('in_els');
    var full = !parseInt(els.mode[0].val());
    
    var ridx = els.rec[0].val();
    var rec = ridx && js.recs[parseInt(ridx)] || null;
    var ijs = !full && rec && rec.doc_ijs || js.ijs;
    
    if(!full && rec && rec.sc_flag & ${REC_FLAG_PARTIAL} && rec.doc_crc !== js.crc) {
        g_v_df_item_lst_ftr_c.show();
        $(g_v_df_item_lst_ftr_c[1]).text(rec.unmatched ? 'Unmatched' : '');
    }
    els.cb_item_sel_all[0].prop('disabled', full).prop('checked', true);
    for(var i = 0; i < js.v_com_lst.length; i++) {
        var v_com = js.v_com_lst[i];
        var t = ijs[i];
        var qty = t.qty;
        v_com[1].prop('disabled', full).val(qty || '');
        v_com[0].prop('disabled', full).prop('checked', !!qty);
        v_com[1].css('background-color', qty ? (qty === js.ijs[i].qty ? '#d4f0c2' : '#cae4ff') : '#faf7c9');
        t.err === 1 ? v_com[2].data('possible_match', t).addClass('row_unmatched') : v_com[2].data('possible_match', null).removeClass('row_unmatched');
    }
    
});

els.cb_item_sel_all[0].change(function() {
    var js = g_v_dlg_doc_form.data('pjs');
    if(!js) return;
    
    var ijs = js.ijs;
    var chk = $(this).prop('checked');
    for(var i = 0; i < js.v_com_lst.length; i++) {
        var v_com = js.v_com_lst[i];
        var qty = chk && ijs[i].qty || 0;
        v_com[0].prop('checked', chk);
        v_com[1].val(qty || '');
        v_com[1].css('background-color', qty ? (qty === js.ijs[i].qty ? '#d4f0c2' : '#cae4ff') : '#faf7c9');
    }
    
});

var ts_doc_lku = null;
var ts_doc_lku_seq = 0;

function _ui_get_doc(sc_id)
{
    var seq = ++ts_doc_lku_seq;
    
    var els = g_v_dlg_doc_form.data('pjs', null).data('in_els');
    els.info[0].val('');
    $(els.rec[0].val('').change().children().slice(1)).remove();
    g_v_df_item_lst_cnt.empty();
    
    var type = els.type[0].val();
    var num = $.trim(els.num[0].val());
    if(!num) return;
    
    if(ts_doc_lku) clearTimeout(ts_doc_lku);
    ts_doc_lku = setTimeout(function() {
        if(seq !== ts_doc_lku_seq) return;
        get_js_ex('?fn=get_doc', {type:type, num:num}, function(js) {
            if(seq !== ts_doc_lku_seq) return;
            
            g_v_dlg_doc_form.data('pjs', js);
            
            var ijs = js.ijs;
            var v_lst = [];
            var v_com_lst = js.v_com_lst = [];
            for(var i = 0; i < ijs.length; i++) {
                var item = ijs[i];
                var item_v_com = [
                                  $('<input type="checkbox" value="'+i+'" onchange="chg__item_list_cb('+i+')" />'),
                                  $('<input type="text" onchange="chg__item_list_in('+i+')" />'),
                ];
                item_v_com[2] = $('<div class="prntbl_row"></div>')
                           .append( $('<div></div>').append(item_v_com[0]) )
                           .append( $('<div></div>').text(item.num) )
                           .append( $('<div></div>').text(item.alu) )
                           .append( $('<div></div>').text(item.name) )
                           .append( $('<div></div>').append(item_v_com[1]).append( $('<span></span>').text('/ ' + item.qty + (item.uom ? ' ' + item.uom : '')) ) );
                item_v_com[2].tooltip({
                    items: '.prntbl_row',
                    content: get_item_possible_match_content
                });
                v_lst.push(item_v_com[2]);
                v_com_lst.push(item_v_com);
            }
            g_v_df_item_lst_cnt.append(v_lst);
            
            var lst = [];
            if(js.company) lst.push(js.company + ' *By ' + js.assoc);
            lst.push('- DocDate: ' + js.doc_date);
            lst.push('- Amount: $' + js.total.toFixed(2));
            lst.push('- Records Found: ' + js.recs.length);
            lst.push('- Zone: ' + js.zone_nz);
            els.info[0].val(lst.join('\n'));
            
            var ol = [];
            var k = -1;
            for(var i = 0; i < js.recs.length; i++) {
                var rec = js.recs[i];
                if(k < 0 && sc_id && rec.sc_id === sc_id) k = i;
                var d = int2date_s(rec.sc_date) + ' - ';
                if(rec.sc_flag & ${REC_FLAG_ACCEPTED}) {
                    if(rec.sc_flag & ${REC_FLAG_CANCELLING}) d += 'Cancelling';
                    else if(rec.sc_flag & ${REC_FLAG_RESCHEDULED}) d += 'Rescheduling' + '('+int2date_s(rec.sc_new_date)+')';
                    else d += 'Accepted';
                } else d += 'Pending';
                
                ol.push( $('<option></option>').val(i + '').text(d) );
            }
            if(ol.length) {
                els.rec[0].append(ol);
                if(sc_id)
                    k >= 0 && els.rec[0].val(k + '').change();
                else
                    els.rec[0].val((ol.length - 1) + '').change();
            } else {
                els.rec[0].change();
            }
            
            var preset_date = g_v_dlg_doc_form.data('preset_date');
            if(preset_date) {
                if(!js.recs.length) {
                    var d_d = preset_date % 100;
                    var d_y = parseInt(preset_date / 100);
                    var d_m = d_y % 100;
                    d_y = parseInt(d_y / 100);
                    els.date[0].datepicker('setDate', new Date(d_y, d_m - 1, d_d));
                }
            }
            
        }, function(t, args) {
            if(t === 1) els.info[0].val(args[0].err_s);
        });
        
    }, 500);
}
load_doc_schedule = _ui_get_doc;
function ui_get_doc() { _ui_get_doc(); }

els.type[0].change(ui_get_doc);
els.num[0].keyup(ui_get_doc);

g_v_x_body = $('.x_body').scroll(function() {
    var st = g_v_x_body.scrollTop();
    var sl = g_v_x_body.scrollLeft();
    
    if(g_v_t_top_hdr.position().top !== st) g_v_t_top_hdr.css('top', st);
    if(g_v_t_left_hdr.position().left !== sl) g_v_t_left_hdr.css('left', sl);
});
g_v_t_top_hdr = $('.t_top_hdr', g_v_x_body);
g_v_t_left_hdr = $('.t_left_hdr', g_v_x_body).tooltip();
g_v_t_body = $('.t_body', g_v_x_body);


g_v_tp_ctrl = $('.tp_ctrl');
idx_elements(g_v_tp_ctrl, 5);
var els = g_v_tp_ctrl.data('in_els');

els.btn_schedule[0].button().click(function() {
    var els = g_v_dlg_doc_form.data('in_els');
    els.num[0].val('');
    g_v_dlg_doc_form.dialog('open');
    ui_get_doc();
    els.num[0].focus();
});


els.user[0].change(load_overview);

window.posx_chk_login_args = function() {
    return {cfg_seq_key: ${CFG_SCHEDULE_UPDATE_SEQ}};
};

window.posx_chk_login_cb = function(js) {
    if(js && js.cfg_seq && js.cfg_seq > g_last_upd_seq) {
        g_last_upd_seq = js.cfg_seq;
        load_overview();
    }
};

load_overview();

}); //ready

</script>

<style type="text/css">
.ui-widget {font-size:16px;}
.tp_ctrl input, .tp_ctrl select {margin-right:10px;}

#dlg_doc_form >div:nth-child(1) input[type="text"] {width:354px}
#dlg_doc_form >div:nth-child(1) select {width:360px}
#dlg_doc_form >div:nth-child(1) textarea {width:354px;height:136px;white-space:nowrap}
#dlg_doc_form >div:nth-child(1) textarea[name="doc_info"] {background-color:#fbfbfb}
#dlg_doc_form >div:nth-child(1) {position:absolute;top:0;left:0;bottom:0;width:480px}
#dlg_doc_form >div:nth-child(2) {position:absolute;top:0;left:480px;bottom:0;right:0;overflow:hidden}
.item_lst .prntbl_row {min-width:1000px}
.item_lst .prntbl_cnt {overflow-x:hidden}
.item_lst .prntbl_row >div:nth-child(1) {width:20px}
.item_lst .prntbl_row >div:nth-child(2) {width:56px;cursor:pointer;font-weight:bold}
.item_lst .prntbl_row >div:nth-child(3) {width:80px}
.item_lst .prntbl_row >div:nth-child(4) {width:300px}
.item_lst .prntbl_row_hdr >div:nth-child(5) {width:104px}
.item_lst .prntbl_cnt .prntbl_row >div:nth-child(5) {position:relative;padding-left:44px;width:60px;font-weight:bold;text-align:left}
.item_lst .prntbl_cnt .prntbl_row >div:nth-child(5) input[type="text"] {width:30px;height:22px !important;position:absolute;top:1px;left:4px;text-align:right}
.item_lst .prntbl_cnt .row_unmatched {background-color:#f78e8e !important}
.item_lst .prntbl_row_ftr >div:nth-child(1) {width:460px;color:#2441c1}
.item_lst .prntbl_row_ftr >div:nth-child(2) {width:120px;color:#e42222}
.p_item_pm {white-space:pre-wrap}

.x_body {padding:40px 0 0 160px;overflow:scroll}
.x_body .t_top_hdr {font-weight:bold;position:absolute;top:0;left:160px;background-color:#f2f5f6;height:39px;color:#27413e;border-top:1px solid #9eb6ce;background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#f2f5f6), color-stop(37%,#e3eaed), color-stop(100%,#c8d7dc));}
.x_body .t_left_hdr {font-weight:bold;position:absolute;top:40px;left:0;background-color:#e4ecf7;width:159px;color:#27413e;border-left:1px solid #9eb6ce;}
.t_block {position:absolute;top:51px;left:0;height:38px;width:158px;background-color:#eaeaea;border:1px solid #9eb6ce}

.x_body .t_row {height:39px;white-space:nowrap}
.x_body .t_row > div {display:inline-block;width:148px;height:38px;text-align:center;line-height:38px;border:1px solid #9eb6ce;border-top:none;border-left:none;}
.x_body .t_left_hdr .t_row > div {width:158px}
.x_body .t_body .t_row > div, .x_body .t_top_hdr .t_row > div {cursor:pointer}
.x_body .t_body >.t_row:nth-child(1) >div, .x_body .t_body >.t_row:nth-child(2) >div {background-color:#f1f1f1}

.x_body .t_top_hdr .t_row > div {width:110px;padding-right:38px;position:relative}
.x_body .t_top_hdr .t_row > div >img {position:absolute;right:4px;top:4px;width:30px;height:30px;}

.ovc_default {margin-right:4px;font-size:20px;font-weight:bold;height:22px;line-height:22px;display:inline-block;color:#fff;border:1px solid rgb(242,130,91);border-radius:5px;padding:2px 4px;background:rgb(242,130,91);background:-webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(242,130,91,1)), color-stop(50%,rgba(229,91,43,1)), color-stop(100%,rgba(240,113,70,1)));}
.ovc_accepted {border-color:#627d4d;background:#627d4d;background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#627d4d), color-stop(100%,#1f3b08));}
.ovc_rescheduled {border-color:#6db3f2;background:#6db3f2;background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(109,179,242,1)), color-stop(50%,rgba(84,163,238,1)), color-stop(51%,rgba(54,144,240,1)), color-stop(100%,rgba(30,105,222,1)));}
.ovc_cancelling {border-color:#ff3019;background:#ff3019;background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(255,48,25,1)), color-stop(100%,rgba(207,4,4,1)));}
.ovc_changed {border-color:#903815;background:#903815;background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(240,183,161,1)), color-stop(50%,rgba(140,51,16,1)), color-stop(51%,rgba(117,34,1,1)), color-stop(100%,rgba(191,110,78,1)));}
.ovc_partial_changed {border-color:rgb(203,96,179);background:rgb(203,96,179);background: -webkit-linear-gradient(top, rgba(203,96,179,1) 0%,rgba(173,18,131,1) 50%,rgba(222,71,172,1) 100%);}

.dd_open {background-color:#d5eab5}
.dd_close {background-color:#f6414d}

#dlg_documents {overflow:hidden}
#dlg_documents > iframe {border:0;margin:0;padding:0;position:absolute;top:0;right:0;width:740px;height:100%;}
#dlg_documents > div:first-child {position:absolute;left:0;top:0;bottom:0;right:740px;border-right:1px solid #ccc}
#dlg_documents > div:first-child > div:first-child {display:none;height:40px;line-height:40px;}

.doc_lst {top:0px;bottom:0;left:0;right:0;overflow:hidden}
.doc_lst .prntbl_row {min-width:1000px}
.doc_lst .prntbl_cnt {overflow-x:hidden}
.doc_lst .prntbl_row >div:nth-child(1) {width:20px;}
.doc_lst .prntbl_row >div:nth-child(2) {width:70px;cursor:pointer}
.doc_lst .prntbl_row >div:nth-child(3) {width:180px;cursor:pointer}
.doc_lst .prntbl_row >div:nth-child(4) {width:80px}
.doc_lst .prntbl_row >div:nth-child(5) {width:50px;font-weight:bold}
.doc_lst .prntbl_row >div:nth-child(6) {width:150px;cursor:pointer}
.doc_lst .prntbl_cnt .prntbl_row >div:nth-child(2) {color:#fff}
.doc_lst .prntbl_row_ftr >div:nth-child(1) {width:380px}

.doc_lst .doc_pending >div:nth-child(2) {background-color:rgb(242,130,91)}
.doc_lst .doc_accepted >div:nth-child(2) {background-color:#627d4d}
.doc_lst .doc_cancelling >div:nth-child(2) {background-color:#ff3019}
.doc_lst .doc_changed >div:nth-child(2) {background-color:#903815}
.doc_lst .doc_rescheduled >div:nth-child(2) {background-color:#3578b5}
.doc_lst .doc_partial_changed >div:nth-child(2) {background-color:rgb(203,96,179)}
.doc_lst .doc_in_delivery_log {background-color:#cfe0c5}

#dlg_help {font-size:72px;font-weight:bold;text-align:center}

.delivered_0 {color:#b43838}
.delivered_1 {color:#33600f}

</style>

</head>
<body>

<div class="tp_ctrl x_ctrl">
<select style="width:180px" name="ctrl_user">
<option value="">-- All Sales --</option>
%for u in sales:
<option value="${u[0]}">${u[1]|h}</option>
%endfor
</select>
<input type="button" name="ctrl_btn_schedule" value="schedule" />

</div>

<div class="x_body">
<div class="t_top_hdr"></div>
<div class="t_left_hdr">
<div class="t_row"><div>All</div></div>
%for z in zones:
<div class="t_row" title="${z[1] or ''|h}"><div>${z[0]|h}</div></div>
%endfor
</div>
<div class="t_body"></div>
</div>
<div class="t_block"></div>

<div id="dlg_doc_del">Are You Sure?</div>

<div id="dlg_doc_form" title="Schedule Form">
<div>
<div class="xlabel"><div>Document:</div><div><select name="doc_type" style="width:124px"><option value="">SalesOrder</option><option value="1">Receipt</option></select><input type="text" name="doc_num" style="width:224px;margin-left:6px;background-color:#fff4da" placeholder="Document Number" /></div></div>
<div class="xlabel" style="height:140px"><div>Result:</div><div><textarea name="doc_info" disabled="disabled"></textarea></div></div>
<div class="xlabel"><div>Record:</div><div><select name="doc_rec" style="background-color:#adc0eb"><option value="">- New -</option></select></div></div>
<div class="xlabel"><div>Date:</div><div><input style="background-color:#daedce" type="text" name="rec_date" placeholder="Scheduled Delivery Date" /></div></div>
<div class="xlabel"><div>Mode:</div><div><select name="rec_mode"><option value="0">Complete Delivery</option><option value="1">Partial Delivery</option></select></div></div>
<div class="xlabel" style="display:none"><div>Priority:</div><div><select name="rec_prio" ><option value="-1">Low</option><option value="0">Normal</option><option value="1">Medium</option><option value="2">High</option></select></div></div>
<div class="xlabel" style="height:130px"><div>Note:</div><div><textarea name="rec_note" style="height:120px"></textarea></div></div>
</div>
<div class="prntbl item_lst">
<div class="prntbl_row prntbl_row_hdr"><div><input type="checkbox" name="rec_cb_item_sel_all" /></div><div>#</div><div>ALU</div><div>Name</div><div>QTY</div></div>
<div class="prntbl_cnt"></div>
<div class="prntbl_row prntbl_row_ftr"><div><input type="checkbox" name="rec_cb_check_n_confirm" /> Document Changed, Please Check And Confirm</div><div></div></div>
</div>
</div>

<div id="dlg_documents">
<div>
<div><select style="width:180px" class="doc_lst_filter"><option>-- ALL --</option><option>Pending</option><option>Accepted</option><option>Rescheduled</option></select></div>
<div class="prntbl doc_lst">
<div class="prntbl_row prntbl_row_hdr"><div><input type="checkbox" /></div><div>Num</div><div>Company</div><div>Amount</div><div>Flag</div><div>Tracking</div></div>
<div class="prntbl_cnt"></div>
<div class="prntbl_row prntbl_row_ftr"><div></div></div>
</div>
</div>

<iframe></iframe>
</div>

</body>
</html>
