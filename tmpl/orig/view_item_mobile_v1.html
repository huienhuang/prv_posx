<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=600,user-scalable=no" />
<script>posx_enable_chk_login = true;</script>
<%include file="header_inc_v3.html" />
<script type="text/javascript" src="js/jquery.mobile.custom.min.js"></script>
<title>POSX - View Item</title>

<script type="text/javascript">

var g_item = null;

function itemsearch_render_item(ul, item)
{
    var d = item[3];
    
    var unit = d.units[d.default_uom_idx];
    var qty = unit[3] ? Math.floor(unit[3] != 1 ? d.qty[0] / unit[3] : d.qty[0]) : 'E';
    return $('<li class="srch_item"></li>').append(
        $('<a></a>')
            .append($('<span></span>').text(item[1]))
            .append($('<span></span>').text( '$' + unit[0][0] + (unit[2] ? '/' + unit[2] : '') + ' (' + qty +')' ))
            .append($('<span></span>').text(d.units[0][1]))
            .append($('<span></span>').text(item[2]))
    ).appendTo(ul);
    
}

function finish_upload_img(lst)
{
    //g_v_img_upload_form[0].reset();
    
    for(var i = 0; i < lst.length; i++) {
        var img = lst[i];
        g_v_item_tbl.picture.prepend( $('<img />').attr('alt', img[0]).attr('src', img[1]).click(load_large_img) );
    }
    
    var srcs = [];
    var imgs = g_v_item_tbl.picture.children('img');
    for(var i = 0; i < imgs.length; i++) srcs.push( $(imgs[i]).attr('src') );
    
    $.post('?fn=set_imgs', {'sid':g_item[0], 'imgs':srcs.join('|')}, function(js) {}, 'json');
}

function load_large_img()
{
    var o = $(this);
    var idx = o.index();
    var src = o.attr('src').replace('_200.', '.');
    g_v_itemsearch.blur();
    setTimeout(function() {
        g_v_pic_cnt.data('idx', idx).show().children('img').attr('src', src);
    }, 200);
    
}

function swipe_large_img(e) {
    e.stopPropagation();
    
    var lst = g_v_item_tbl.picture.children('img');
    var idx = g_v_pic_cnt.data('idx');
    
    if (e.swipestart.coords[0] > e.swipestop.coords[0])
        idx++;
    else
        idx--;
    
    idx = (idx + lst.length) % lst.length;
    var src = $(lst[idx]).attr('src').replace('_200.', '.');
    g_v_pic_cnt.data('idx', idx).children('img').attr('src', src);
}

g_v_ajax_seq__load_imgs = 0;
function load_imgs(sid)
{
    g_v_item_tbl.picture.empty();
    var seq = ++g_v_ajax_seq__load_imgs;
    $.get('?fn=get_imgs', {'sid':sid}, function(js) {
        if(seq !== g_v_ajax_seq__load_imgs || !js || !js.imgs) return;
        
        var imgs = js.imgs.split('|');
        for(var i = 0; i < imgs.length; i++)
            g_v_item_tbl.picture.append( $('<img alt="IMG" />').attr('src', imgs[i]).click(load_large_img) );
        
    }, 'json');
}

function OnPictureReady()
{
    var pic = window.Android.getPicture();
    $.post('sfile?fn=upload_img_v1', {'img': pic}, finish_upload_img, 'json');
}

function OnBarcodeReady()
{
    var barcode = window.Android.getBarcode();
    g_v_itemsearch.val(barcode).autocomplete('searchNow');
}


$(function() {

g_v_m_top = $('.m_top');

$('input[name="ctrl_add_img"]', g_v_m_top).button().click(function() {
    if(g_item) window.Android && window.Android.takePicture();
});

$('input[name="ctrl_scan_barcode"]', g_v_m_top).button().click(function() {
    window.Android && window.Android.scanBarcode();
});

$('input[name="ctrl_clear_search"]', g_v_m_top).button().click(function() {
    g_v_itemsearch.val('');
});


g_v_itemsearch = $('[name="ctrl_search"]', g_v_m_top);

init_item_ac(
    '[name="ctrl_search"]',
    function(evt, ui) {
        var item = g_item = ui.item;
        
        g_v_item_tbl.name.empty()
        .append( $('<span><span>').text('*'+item[1]+'*') )
        .append( $('<span><span>').text(item[2]) );
        
        g_v_item_tbl.unit.empty();
        var units = item[3].units;
        for(var i = 0; i < units.length; i++) {
            var unit = units[i];
            g_v_item_tbl.unit.append(
                $('<div></div>')
                .append( $('<div></div>').text( '$' + unit[0][0] + (unit[2] ? '/' + unit[2] + (unit[3] != 1 ? '('+unit[3]+')' : '') : '') + ' ' ) )
                .append( $('<div></div>').text( unit[1] + ' ' ) )
                .append( $('<div></div>').text( unit[4]) )
            );
        }
        
        g_v_item_tbl.vend.empty();
        var vends = item[3].vends;
        for(var i = 0; i < vends.length; i++) {
            var vend = vends[i];
            if(vend[0]) {
                g_v_item_tbl.vend.append(
                    $('<div></div>')
                    .append( $('<div></div>').text(vend[0]) )
                    .append( $('<div></div>').text(vend[1]) )
                    .append( $('<div></div>').text(vend[2]) )
                );
            }
        }
        
        g_v_item_tbl.inv.empty();
        var qty = item[3].qty.slice(0);
        var def_unit = units[ item[3].default_uom_idx ];
        if(def_unit[3]) {
            
            if (def_unit[3] != 1) {
                qty[0] /= def_unit[3];
                qty[1] /= def_unit[3];
                qty[3] /= def_unit[3];
            }
            
            g_v_item_tbl.inv
            .append($('<div></div>').text('现有: ' + Math.floor(qty[0]) + ' ' + def_unit[2]))
            .append($('<div></div>').text('订单: ' + Math.floor(qty[1]) + ' ' + def_unit[2]))
            .append($('<div></div>').text('购买: ' + Math.floor(qty[3]) + ' ' + def_unit[2]));
            
        }
        
        load_imgs(item[0]);
    },
    {
        source: "sync?fn=itemsearch",
        delay: 500,
        position: {mode:1},
        autoSelect: true
    },
    itemsearch_render_item
    
); //init_item_ac

var lst = $('.item_info_tbl > div > div:nth-child(2)');
g_v_item_tbl = {
    'name': $(lst[0]),
    'inv': $(lst[1]),
    'unit': $(lst[2]),
    'vend': $(lst[3]),
    'picture': $(lst[4]),
}

g_v_pic_cnt = $('.m_pic_cnt').click(function() { $(this).hide(); });
g_v_pic_cnt.on('swipe', swipe_large_img);


g_v_tools_cnt = $('.m_tools_cnt');
g_v_checkboxes = g_v_tools_cnt.find('.tg_checkbox').click(function() {
    if(!g_item) return;
    
    var o = $(this);
    var on;
    if( o.hasClass('tg_checkbox_active') ) {
        on = 0;
        o.removeClass('tg_checkbox_active');
    } else {
        on = 1;
        o.addClass('tg_checkbox_active');
    }
    
    var idx = o.attr('id').substr(13);
    post_js_ex('?fn=set_single_inv_flag', {idx:idx, on:on, sid:g_item[0]});
    
});


$(document).on('swipe', function(e) {
    if (e.swipestart.coords[0] > e.swipestop.coords[0]) {
        if(!g_item) return;
        g_v_checkboxes.hide();
        g_v_tools_cnt.show();
        
        var sid = g_item[0];
        get_js('?fn=get_inv_flag', {sid: sid}, function(js) {
            if(!g_item || g_item[0] !== sid) return;
            
            for(var i = 0; i < g_v_checkboxes.length; i++) {
                var cb = $(g_v_checkboxes[i]);
                cb.show();
                if(js.flag & (1 << parseInt(cb.attr('id').substr(13))))
                    cb.addClass('tg_checkbox_active');
                else
                    cb.removeClass('tg_checkbox_active');
            }
            
        });
        
    } else
        g_v_tools_cnt.hide();
    
});


}); //-ready

</script>

<style type="text/css">
body {margin:0 auto;padding-top:51px}

.m_top {position:fixed;border-bottom:1px solid #ddd;top:0;left:0;right:0;height:42px;padding:4px;line-height:42px;background-color:#f9f9f9}
.m_top input {vertical-align:bottom;margin-left:5px;height:36px !important;font-size:26px !important}
.m_top input[type="button"] {height:42px !important;padding:2px 10px !important;}

.m_pic_cnt {display:none;position:fixed;top:0;left:0;bottom:0;right:0;background:url("img/overlay.png") repeat;text-align:center}
.m_pic_cnt >img {max-height:100%;max-width:100%}

.m_tools_cnt {display:none;position:fixed;top:0;left:0;bottom:0;right:0;background-color:#fdfdfd;padding:30px;}

.tg_checkbox {cursor:pointer;width:200px;font-weight:bold;height:40px;line-height:40px;text-align:center;border:1px solid #ddd;border-radius:10px;padding:10px 0;margin:0 auto 20px auto;background:#fff;background:-webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(50%,#f3f3f3), color-stop(51%,#ededed), color-stop(100%,#ffffff));}
.tg_checkbox.tg_checkbox_active {background: rgb(180,227,145);background:-webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(180,227,145,1)), color-stop(50%,rgba(97,196,25,1)), color-stop(100%,rgba(180,227,145,1)));}

.item_info_tbl > div {position:relative;border-bottom:1px solid #ddd;margin:0;padding-left:70px;line-height:40px;font-size:22px;}
.item_info_tbl > div > div {min-height:40px;}
.item_info_tbl > div > div:nth-child(1) {position:absolute;background-color:#f1f1f1;top:0;bottom:0;left:0;width:60px;padding-right:10px;text-align:right}
.item_info_tbl > div > div:nth-child(2) {text-align:center;padding:6px 0px}

.ui-autocomplete {top:51px;left:0;bottom:0;right:0;border:none;padding:0;position:fixed}
.ui-menu > .ui-menu-item {width:auto;height:66px}
.ui-menu > .ui-menu-item > a {font-size:20px;width:auto;height:60px}
.ui-menu > .ui-menu-item > a > span {height:30px;line-height:30px}
.ui-menu > .ui-menu-item.srch_item > a > span:nth-child(1) {width:70px}
.ui-menu > .ui-menu-item.srch_item > a > span:nth-child(2) {width:160px}
.ui-menu > .ui-menu-item.srch_item > a > span:nth-child(3) {width:240px;margin-right:0;}
.ui-menu > .ui-menu-item.srch_item > a > span:nth-child(4) {width:auto;margin-right:0;clear:left}

.item_unit > div {height:40px;}
.item_unit > div > div {float:left;height:40px;white-space:nowrap;overflow:hidden;border-right:1px dotted #ddd}
.item_unit > div > div:nth-child(1) {color:#394c8a;width:148px;}
.item_unit > div > div:nth-child(2) {color:#4e6f15;width:190px;}
.item_unit > div > div:nth-child(3) {color:#833f16;width:190px;border-right:none}
.item_unit > div:nth-child(even) {background-color:#fdf3e4}

.item_vend > div {height:40px;}
.item_vend > div > div {float:left;height:40px;white-space:nowrap;overflow:hidden;border-right:1px dotted #ddd}
.item_vend > div > div:nth-child(1) {color:#833f16;width:148px;}
.item_vend > div > div:nth-child(2) {color:#4e6f15;width:190px;}
.item_vend > div > div:nth-child(3) {color:#833f16;width:190px;border-right:none}
.item_vend > div:nth-child(even) {background-color:#fdf3e4}

.item_pics {max-height:120px;white-space:nowrap;overflow-y:hidden;overflow-x:auto}
.item_pics > img {max-width:120px;max-height:120px;padding-left:5px;}

.item_name > span:nth-child(1) {font-weight:bold;color:#0f3a6b;padding-right:10px;}


.item_inv > div {float:left;height:40px;white-space:nowrap;overflow:hidden;font-weight:bold;width:176px}
.item_inv > div:nth-child(1) {color:#37461b}
.item_inv > div:nth-child(2) {color:#2d4396}
.item_inv > div:nth-child(3) {color:#882525}


</style>

</head>
<body>
<div class="m_top">
<input type="text" name="ctrl_search" style="width:200px" />
<input type="button" value="清空" name="ctrl_clear_search" />
<input type="button" value="扫描" name="ctrl_scan_barcode" />
<input type="button" value="照片" name="ctrl_add_img" />
</div>

<div class="item_info_tbl">
<div><div>名称</div><div class="item_name"></div></div>
<div><div>库存</div><div class="item_inv"></div></div>
<div><div>单位</div><div class="item_unit"></div></div>
<div><div>厂商</div><div class="item_vend"></div></div>
<div><div>图片</div><div class="item_pics"></div></div>
</div>

<div class="m_pic_cnt"><img alt="" border="0" /></div>

<div class="m_tools_cnt">

<div class="tg_checkbox" id="inv_flag_idx_0">Small Label</div>
<div class="tg_checkbox" id="inv_flag_idx_1">Large Label</div>
<div class="tg_checkbox" id="inv_flag_idx_2">Warehouse Label</div>
<div class="tg_checkbox" id="inv_flag_idx_8">Low Stock</div>

</div>

</body>
</html>
