<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=600,user-scalable=no" />
<script>posx_enable_chk_login = true;</script>
<%include file="header_mobile.html" />
<title>POSX - View Item</title>

<script type="text/javascript">

var g_item = null;

function itemsearch_render_item(ul, item)
{
    var d = item[3];
    
    var unit = d.units[d.default_uom_idx];
    var qty = unit[3] ? Math.floor(unit[3] != 1 ? d.qty[0] / unit[3] : d.qty[0]) : 'E';
    return $('<li class="srch_item"></li>').append(
        $('<a></a>')
            .append($('<span></span>').text(item[1]))
            .append($('<span></span>').text( '$' + unit[0][0] + (unit[2] ? '/' + unit[2] : '') + ' (' + qty +')' ))
            .append($('<span></span>').text(d.units[0][1]))
            .append($('<span></span>').text(item[2]))
    ).appendTo(ul);
    
}

function finish_upload_img(lst)
{
    //g_v_img_upload_form[0].reset();
    
    for(var i = 0; i < lst.length; i++) {
        var img = lst[i];
        g_v_item_tbl.picture.prepend( $('<img />').attr('alt', img[0]).attr('src', img[1]).click(load_large_img) );
    }
    
    var srcs = [];
    var imgs = g_v_item_tbl.picture.children('img:not(.google_img)');
    for(var i = 0; i < imgs.length; i++) srcs.push( $(imgs[i]).attr('src') );
    
    $.post('?fn=set_imgs', {'sid':g_item[0], 'imgs':srcs.join('|')}, function(js) {}, 'json');
}

function load_large_img()
{
    var o = $(this);
    var idx = o.index();
    var src = o.hasClass('google_img') ? o.data('full_url') : o.attr('src').replace('_200.', '.');
    g_v_itemsearch.blur();
    setTimeout(function() {
        g_v_itemsearch.blur();
        g_v_pic_cnt.data('idx', idx).show().children('img').attr('src', src);
    }, 200);
    
}

function swipe_large_img(e) {
    e.stopPropagation();
    
    var lst = g_v_item_tbl.picture.children('img');
    var idx = g_v_pic_cnt.data('idx');
    
    if (e.swipestart.coords[0] > e.swipestop.coords[0])
        idx++;
    else
        idx--;
    
    idx = (idx + lst.length) % lst.length;
    var o = $(lst[idx]);
    var src = o.hasClass('google_img') ? o.data('full_url') : o.attr('src').replace('_200.', '.');
    g_v_pic_cnt.data('idx', idx).children('img').attr('src', src);
}

function load_imgs(sid, nz)
{
    if(!window.__load_imgs_seq) window.__load_imgs_seq = 0;
    var seq = ++window.__load_imgs_seq;
    
    g_v_item_tbl.picture.empty();
    get_js('?fn=get_imgs', {'sid':sid}, function(js) {
        if(seq !== window.__load_imgs_seq) return;
        
        if(js.imgs) {
            var imgs = js.imgs.split('|');
            for(var i = 0; i < imgs.length; i++)
                g_v_item_tbl.picture.append( $('<img alt="IMG" />').attr('src', imgs[i]).click(load_large_img) );
        } else {
            load_google_imgs(seq, nz);
            
        }
        
    });
}

function load_google_imgs(seq, nz)
{
    $.get('https://ajax.googleapis.com/ajax/services/search/images?v=1.0',
        {q: nz},
        function(js) {
            if(seq !== window.__load_imgs_seq) return;
            
            if(js.responseData) {
                g_v_item_tbl.picture.append( $('<img alt="IMG" class="google_img" />').data('full_url', 'img/not_found.png').attr('src', 'img/not_found.png').click(load_large_img) );
                var results = js.responseData.results;
                var max_len = Math.max(4, results.length);
                for(var i = 0; i < max_len; i++) {
                    var r = results[i];
                    g_v_item_tbl.picture.append( $('<img alt="IMG" class="google_img" />').data('full_url', r.unescapedUrl).attr('src', r.tbUrl).click(load_large_img) );
                }
            }
            
        }, 'jsonp'
    );
}

function OnPictureReady()
{
    var pic = window.Android.getPicture();
    $.post('sfile?fn=upload_img_v1', {'img': pic}, finish_upload_img, 'json');
}

function OnBarcodeReady()
{
    var barcode = window.Android.getBarcode();
    g_v_itemsearch.val(barcode).autocomplete('searchNow');
}

function show_tools()
{
    g_v_itemsearch.blur();
    
    if(!g_item) return;
    g_v_checkboxes.hide();
    g_v_tools_cnt.show();
    refresh_tools();
}


function refresh_tools()
{
    var sid = g_item[0];
    get_js('?fn=get_inv_flag', {sid: sid}, function(js) {
        if(!g_item || g_item[0] !== sid) return;
        g_v_checkboxes.show();
        
        for(var i = 0; i < g_v_checkboxes.length; i++) {
            var cb = $(g_v_checkboxes[i]);
            if(js.flag & (1 << parseInt(cb.attr('id').substr(13))))
                cb.addClass('tg_checkbox_active');
            else
                cb.removeClass('tg_checkbox_active');
        }
    });
}

function update_inv_stat()
{
    var js = g_v_inv_cnt_units.data('js');
    if(!js) return;
    
    var units = js.units;
    var total = 0;
    for(var i = 0; i < units.length; i++) {
        var u = units[i];
        total += u[1] * (parseInt(u[2].val()) || 0);
    }
    $(g_v_inv_cnt_stats[1]).text( total.toFixed(1) );
}

function show_inv()
{
    g_v_itemsearch.blur();
    
    g_v_inv_cnt_units.data('js', null).empty();
    g_v_inv_cnt.data('v_inv_agree').prop('checked', false);
    if(!g_item) return;
    g_v_inv_cnt.show();
    
    var sid = g_item[0];
    get_js_ex('?fn=get_item_unit', {sid: sid}, function(js) {
        if(!g_item || g_item[0] !== sid) return;
        
        g_v_inv_cnt_units.data('js', js);
        var v_lst = [];
        for(var i = 0; i < js.units.length; i++) {
            var u = js.units[i];
            u[2] = $('<input onchange="update_inv_stat()" type="text" />');
            v_lst.push(
                $('<div></div>')
                       .append( u[2] )
                       .append( $('<span></span>').text(u[0] + (u[1] == 1 ? '' : ' (*' + u[1] + ')'))
                )
            );
        }
        g_v_inv_cnt_units.append(v_lst);
        
        $(g_v_inv_cnt_stats[3]).text(js.qty.toFixed(1));
        update_inv_stat();
        
    }, undefined, undefined, "Loading ...", "view_mobile_show_inv");
}

function onclick_btn_inv_btn(evt, mode)
{
    if(!g_item) return;
    if(!g_v_inv_cnt.data('v_inv_agree').prop('checked')) return;
    
    var js = g_v_inv_cnt_units.data('js');
    if(!js) return;
    
    
    var lst = [];
    var pass = false;
    for(var i = 0; i < js.units.length; i++) {
        var u = js.units[i];
        var v = $.trim(u[2].val());
        lst.push( [u[0], u[1], v] );
        if(v) pass = true;
    }
    if(!pass) return;
    
    if(mode) {
        post_js_ex('?fn=set_item_qty', {'sid': g_item[0], 'cur_qty': js.qty, 'js': JSON.stringify(lst)}, function() {
            show_inv();
        });
        
    } else {
        g_dlg_confirm_chg_qty.dialog('open');
        
    }
    
}


$(function() {

g_v_m_top = $('.m_top');

$('input[name="ctrl_add_img"]', g_v_m_top).button().click(function() {
    if(g_item) window.Android && window.Android.takePicture();
});

$('input[name="ctrl_scan_barcode"]', g_v_m_top).button().click(function() {
    window.Android && window.Android.scanBarcode();
});

$('input[name="ctrl_clear_search"]', g_v_m_top).button().click(function() {
    g_v_itemsearch.val('');
});

g_v_itemsearch = $('[name="ctrl_search"]', g_v_m_top);

init_item_ac(
    '[name="ctrl_search"]',
    function(evt, ui) {
        var item = g_item = ui.item;
        
        g_v_item_tbl.name.empty()
        .append( $('<span><span>').text('*'+item[1]+'*') )
        .append( $('<span><span>').text(item[2]) );
        
        g_v_item_tbl.unit.empty();
        var units = item[3].units;
        for(var i = 0; i < units.length; i++) {
            var unit = units[i];
            g_v_item_tbl.unit.append(
                $('<div></div>')
                .append( $('<div></div>').text( '$' + unit[0][0] + (unit[2] ? '/' + unit[2] + (unit[3] != 1 ? '('+unit[3]+')' : '') : '') + ' ' ) )
                .append( $('<div></div>').text( unit[1] + ' ' ) )
                .append( $('<div></div>').text( unit[4]) )
            );
        }
        
        g_v_item_tbl.vend.empty();
        var vends = item[3].vends;
        for(var i = 0; i < vends.length; i++) {
            var vend = vends[i];
            if(vend[0]) {
                g_v_item_tbl.vend.append(
                    $('<div></div>')
                    .append( $('<div></div>').text(vend[0]) )
                    .append( $('<div></div>').text(vend[1]) )
                    .append( $('<div></div>').text(vend[2]) )
                );
            }
        }
        
        g_v_item_tbl.inv.empty();
        var qty = item[3].qty.slice(0);
        var def_unit = units[ item[3].default_uom_idx ];
        if(def_unit[3]) {
            
            if (def_unit[3] != 1) {
                qty[0] /= def_unit[3];
                qty[1] /= def_unit[3];
                qty[3] /= def_unit[3];
            }
            
            g_v_item_tbl.inv
            .append($('<div></div>').text('现有: ' + Math.floor(qty[0]) + ' ' + def_unit[2]))
            .append($('<div></div>').text('订单: ' + Math.floor(qty[1]) + ' ' + def_unit[2]))
            .append($('<div></div>').text('购买: ' + Math.floor(qty[3]) + ' ' + def_unit[2]));
            
        }
        
        load_imgs(item[0], item[3].desc1 || item[2]);
    },
    {
        source: "?fn=search_item",
        delay: 500,
        position: {mode:1},
        autoSelect: true
    },
    itemsearch_render_item
    
); //init_item_ac

var lst = $('.item_info_tbl > div > div:nth-child(2)');
g_v_item_tbl = {
    'name': $(lst[0]),
    'inv': $(lst[1]),
    'unit': $(lst[2]),
    'vend': $(lst[3]),
    'picture': $(lst[4]),
}

g_v_pic_cnt = $('.m_pic_cnt').click(function() { $(this).hide(); });

g_v_tools_cnt = $('.m_tools_cnt');
g_v_checkboxes = g_v_tools_cnt.find('.tg_checkbox').click(function() {
    if(!g_item) return;
    
    var o = $(this);
    var idx = o.attr('id').substr(13);
    post_js_ex('?fn=set_single_inv_flag', {idx:idx, on: o.hasClass('tg_checkbox_active') ? 0 : 1, sid:g_item[0]}, function() {
        refresh_tools();    
    });
    
});

g_v_inv_cnt = $('.m_inv_cnt');
g_v_inv_cnt_units = g_v_inv_cnt.children('.inv_units');
g_v_inv_cnt_stats = g_v_inv_cnt.children('.inv_stats').children();

g_v_inv_cnt.find('.btn_inv_set').button().click(onclick_btn_inv_btn);
g_v_inv_cnt.data('v_inv_agree', g_v_inv_cnt.find('input[name="inv_agree"]'));


$('.item_info_tbl').on('swipeleft', show_tools).on('swiperight', show_inv);
g_v_inv_cnt.on('swipe', function(e) {
    if (e.swipestart.coords[0] < e.swipestop.coords[0])
        show_inv(); 
    else
        g_v_inv_cnt.hide();
});
g_v_tools_cnt.on('swipe', function(e) {
    if (e.swipestart.coords[0] > e.swipestop.coords[0])
        show_tools(); 
    else
        g_v_tools_cnt.hide();
});
g_v_pic_cnt.on('swipe', swipe_large_img);


g_dlg_confirm_chg_qty = $('#dlg_confirm_chg_qty').dialog({
    resizable: false,
    autoOpen: false,
    modal: true,
    buttons: {
        'Yes': function() {
            g_dlg_confirm_chg_qty.dialog('close');
            onclick_btn_inv_btn(null, 1);
        },
        'Cancel': function() {
            g_dlg_confirm_chg_qty.dialog('close');
        }
    }
});

}); //-ready

</script>

<style type="text/css">
body {margin:0 auto;padding-top:51px}

.m_top {position:fixed;border-bottom:1px solid #ddd;top:0;left:0;right:0;height:42px;padding:4px;line-height:42px;background-color:#f9f9f9}
.m_top input {vertical-align:bottom;margin-left:5px;height:36px !important;font-size:26px !important}
.m_top input[type="button"] {height:42px !important;padding:2px 10px !important;}

.app_mode_developer {background-color:#ffecec}

.m_dlg_cnt {display:none;position:fixed;top:0;left:0;bottom:0;right:0;}
.m_pic_cnt {background:url("img/overlay.png") repeat;text-align:center}
.m_pic_cnt >img {max-height:100%;max-width:100%}
.m_tools_cnt, .m_inv_cnt {background-color:#fdfdfd;padding:30px;}

.tg_checkbox {cursor:pointer;width:200px;font-weight:bold;height:40px;line-height:40px;text-align:center;border:1px solid #ddd;border-radius:10px;padding:10px 0;margin:0 auto 20px auto;background:#fff;background:-webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(50%,#f3f3f3), color-stop(51%,#ededed), color-stop(100%,#ffffff));}
.tg_checkbox.tg_checkbox_active {background: rgb(180,227,145);background:-webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(180,227,145,1)), color-stop(50%,rgba(97,196,25,1)), color-stop(100%,rgba(180,227,145,1)));}

.item_info_tbl {position:absolute;top:51px;right:0;bottom:0;left:0;}
.item_info_tbl > div {position:relative;border-bottom:1px solid #ddd;margin:0;padding-left:70px;line-height:40px;font-size:22px;}
.item_info_tbl > div > div {min-height:40px;}
.item_info_tbl > div > div:nth-child(1) {position:absolute;background-color:#f1f1f1;top:0;bottom:0;left:0;width:60px;padding-right:10px;text-align:right}
.item_info_tbl > div > div:nth-child(2) {text-align:center;padding:6px 0px}

.ui-autocomplete {top:51px;left:0;bottom:0;right:0;border:none;padding:0;position:fixed}
.ui-menu > .ui-menu-item {width:auto;height:66px}
.ui-menu > .ui-menu-item > a {font-size:20px;width:auto;height:60px}
.ui-menu > .ui-menu-item > a > span {height:30px;line-height:30px}
.ui-menu > .ui-menu-item.srch_item > a > span:nth-child(1) {width:70px}
.ui-menu > .ui-menu-item.srch_item > a > span:nth-child(2) {width:160px}
.ui-menu > .ui-menu-item.srch_item > a > span:nth-child(3) {width:240px;margin-right:0;}
.ui-menu > .ui-menu-item.srch_item > a > span:nth-child(4) {width:auto;margin-right:0;clear:left}

.item_unit > div {height:40px;}
.item_unit > div > div {float:left;height:40px;white-space:nowrap;overflow:hidden;border-right:1px dotted #ddd}
.item_unit > div > div:nth-child(1) {color:#394c8a;width:148px;}
.item_unit > div > div:nth-child(2) {color:#4e6f15;width:190px;}
.item_unit > div > div:nth-child(3) {color:#833f16;width:190px;border-right:none}
.item_unit > div:nth-child(even) {background-color:#fdf3e4}

.item_vend > div {height:40px;}
.item_vend > div > div {float:left;height:40px;white-space:nowrap;overflow:hidden;border-right:1px dotted #ddd}
.item_vend > div > div:nth-child(1) {color:#833f16;width:148px;}
.item_vend > div > div:nth-child(2) {color:#4e6f15;width:190px;}
.item_vend > div > div:nth-child(3) {color:#833f16;width:190px;border-right:none}
.item_vend > div:nth-child(even) {background-color:#fdf3e4}

.item_pics {max-height:120px;white-space:nowrap;overflow:hidden}
.item_pics > img {max-width:120px;max-height:120px;padding-left:5px;}

.item_name > span:nth-child(1) {font-weight:bold;color:#0f3a6b;padding-right:10px;}


.item_inv > div {float:left;height:40px;white-space:nowrap;overflow:hidden;font-weight:bold;width:176px}
.item_inv > div:nth-child(1) {color:#37461b}
.item_inv > div:nth-child(2) {color:#2d4396}
.item_inv > div:nth-child(3) {color:#882525}

.m_inv_cnt {font-size:26px;}
.m_inv_cnt > div:last-child {text-align:center;margin-top:20px}
.m_inv_cnt .inv_stats {height:40px;line-height:40px;margin:10px 0 20px 0;overflow:hidden}
.m_inv_cnt .inv_stats > div {margin-right:5px;font-weight:bold;float:left;height:100%;width:100px}
.m_inv_cnt .inv_stats > div:nth-child(1) {color:#579942;width:140px}
.m_inv_cnt .inv_stats > div:nth-child(3) {color:#1c4a8f;width:120px;margin-left:20px;}

.m_inv_cnt > div:first-child {height:200px}
.m_inv_cnt > div:first-child > div {height:40px;line-height:40px;padding:5px;}
.m_inv_cnt input[type="text"] {height:34px !important;font-size:26px !important;width:100px;margin-right:10px;}
.m_inv_cnt input[type="button"] {height:60px !important;font-size:32px !important;width:200px;}

</style>

</head>
<body>

<div class="item_info_tbl">
<div><div>名称</div><div class="item_name"></div></div>
<div><div>库存</div><div class="item_inv"></div></div>
<div><div>单位</div><div class="item_unit"></div></div>
<div><div>厂商</div><div class="item_vend"></div></div>
<div><div>图片</div><div class="item_pics"></div></div>
</div>

<div class="m_top app_mode_${mode}">
<input type="text" name="ctrl_search" style="width:200px" />
<input type="button" value="清空" name="ctrl_clear_search" />
<input type="button" value="扫描" name="ctrl_scan_barcode" />
<input type="button" value="照片" name="ctrl_add_img" />
</div>

<div class="m_pic_cnt m_dlg_cnt"><img alt="" border="0" /></div>

<div class="m_tools_cnt m_dlg_cnt">
<div class="tg_checkbox" id="inv_flag_idx_0">打印小标签</div>
<div class="tg_checkbox" id="inv_flag_idx_1">打印大标签</div>
<div class="tg_checkbox" id="inv_flag_idx_2">打印仓库标签</div>

<div class="tg_checkbox" id="inv_flag_idx_24">反映 低库存</div>
<div class="tg_checkbox" id="inv_flag_idx_25">反映 无库存</div>
<div class="tg_checkbox" id="inv_flag_idx_26">反映 信息错误</div>

</div>

<div class="m_inv_cnt m_dlg_cnt">
<div class="inv_units"></div>
<div class="inv_stats"><div>PhyCount:</div><div></div><div>OnHand:</div><div></div></div>
<div><input type="checkbox" name="inv_agree" /> I agree to change it</div>
<div><input type="button" value="Set" class="btn_inv_set" /></div>
</div>

<div id="dlg_confirm_chg_qty" title="Confirmation"><span>Are You Sure To Change The Qty?</span></div>


</body>
</html>
