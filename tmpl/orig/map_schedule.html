<!DOCTYPE html>
<html>
<head>
<%include file="header_inc_v4.html" />
<title>POSX - Schedule Map</title>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAgOdCwrMp6iW9YdoC8bCVmFVwuHghE0ug"></script>
<script type="text/javascript">
g_doc_js = null;
g_map = null;
g_ctrl_down = false;

function locate(i, dont_center) {
    if(!g_doc_js) return;
    if(g_doc_js.fi !== undefined && g_doc_js.lst[g_doc_js.fi]) {
        var r = g_doc_js.lst[g_doc_js.fi];
        var marker = r.marker;
        if(marker) {
            marker.setAnimation(null);
            if(r.selected)
                marker.setIcon('img/marker/blue_'+(g_doc_js.fi+1)+'.png');
            else
                marker.setIcon('img/marker/orange_'+(g_doc_js.fi+1)+'.png');
        }
    }
    g_doc_js.fi = i;
    
    if(!g_doc_js.lst[i]) return;
    var r = g_doc_js.lst[i];
    if(!r.marker) return;
    
    dont_center || g_map.setCenter(r.marker.getPosition());
    r.marker.setIcon('img/marker/green_'+(i+1)+'.png');
    r.marker.setAnimation(google.maps.Animation.BOUNCE);
}

function load_doc(i)
{
    g_v_doc_wnd.attr('src', 'about:blank');
    if(!g_doc_js) return;
    if(!g_doc_js.lst[i]) return;
    var r = g_doc_js.lst[i];
    
    g_v_dlg_view_doc.dialog('open');
    g_v_doc_wnd.attr('src', '?fn=print&view_only=1&sc_ids=' + r.sc_id);
}

function chg_doc_cb()
{
    if(!g_doc_js) return;
    var o = $(this);
    var i = parseInt(o.val());
    if(!g_doc_js.lst[i]) return;
    
    var r = g_doc_js.lst[i];
    var sel = o.prop('checked');
    if (sel === r.selected) return;
    r.selected = sel;
    
    var lst = g_doc_js.lst;
    var sc = 0;
    for(var j = 0; j < lst.length; j++) lst[j].selected && ++sc;
    $(g_v_doc_lst_ftr[1]).text('Selected: ' + sc);
    
    if(g_doc_js.fi === i) return;
    var marker = r.marker;
    if(!marker) return;
    if(r.selected)
        marker.setIcon('img/marker/blue_'+(i+1)+'.png');
    else
        marker.setIcon('img/marker/orange_'+(i+1)+'.png');
}

function int2date_s(i) {
    var s = i + '';
    return s.substr(s.length - 4, 2) + '/' + s.substr(s.length - 2, 2) + '/' + s.substr(0, s.length - 4);
}

function load_doc_lst(dt, zidx, clerk_id)
{
    g_v_doc_lst_ftr.empty();
    g_v_doc_lst.empty();
    if(g_doc_js) {
        for(var i = 0; i < g_doc_js.lst.length; i++) {
            var r = g_doc_js.lst[i];
            if(r.marker) {
                r.marker.setMap(null);
                r.marker = null;
            }
        }
    }
    g_doc_js = null;
    
    get_js_ex('?fn=get_docs', {dt: dt, zone_id: zidx, clerk_id: clerk_id, sort_reg: 1, pending_only: parseInt(g_v_doc_filter.val()) || 0}, function(js) {
        g_doc_js = js;
        
        var dc = 0;
        var lst = [];
        for(var i = 0; i < js.lst.length; i++) {
            var r = js.lst[i];
            //r.i = i;
            dc += r.delivery_count ? 1 : 0;
            
            var cls = '';
            if(r.sc_flag & ${REC_FLAG_ACCEPTED}) {
                if(r.sc_flag & ${REC_FLAG_CANCELLING}) cls = ' doc_cancelling';
                else if(r.sc_flag & ${REC_FLAG_RESCHEDULED}) cls = ' doc_rescheduled';
                else if(r.sc_flag & ${REC_FLAG_CHANGED}) cls = ' doc_changed';
                else cls = ' doc_accepted';
            } else cls = ' doc_pending';
            
            lst.push(
                $('<div class="prntbl_row'+cls+'"></div>')
                .append( $('<div><input type="checkbox" value="'+i+'" checked="checked" /></div>') )
                .append( $('<div>'+(i+1)+'</div>') )
                .append( $('<div onclick="load_doc('+i+')"></div>').text(r.num + (r.sc_flag & ${REC_FLAG_R_RESCHEDULED} ? '*' : '')) )
                .append( $('<div'+(r.delivery_count ? ' class="doc_in_delivery_log"' : '')+' onclick="locate('+i+')"></div>').text(r.cust_nz) )
                .append( $('<div></div>').text(r.doc_amt.toFixed(2)) )
                .append( $('<div></div>').text( (r.sc_note_len ? '*' : '') + (r.doc_dup > 1 ? r.doc_dup : '') ) )
            );
            r.selected = 1;
            
            r.marker = null;
            if(r['doc_geo']) {
                r.marker = new google.maps.Marker({
                    position: new google.maps.LatLng(r['doc_geo'][1],r['doc_geo'][2]),
                    map: g_map,
                    icon: 'img/marker/blue_'+(i+1)+'.png',
                });
                
                (function(i) {
                    r.marker.addListener('click', function(evt) {
                        if(g_ctrl_down) {
                            v_cb = $(js.v_cbs[i]);
                            v_cb.prop('checked', !v_cb.prop('checked')).change();
                        } else {
                            locate(i, 1);
                            load_doc(i);
                        }
                    });
                })(i);
            }
        }
        
        g_v_doc_lst.append(lst);
        js.v_cbs = g_v_doc_lst.find('input[type="checkbox"]').change(chg_doc_cb);
        $(g_v_doc_lst_ftr[0]).text('Date: ' + int2date_s(js.date) + ', Total: ' + js.lst.length + ', Fill: ' + dc);
        $(g_v_doc_lst_ftr[1]).text('Selected: ' + js.lst.length);
        
    }, undefined, undefined, undefined, '__load_doc_lst__');
    
}

function get_selected_docs() {
    var lst = [];
    if(!g_doc_js) return lst;
    for(var i = 0; i < g_doc_js.lst.length; i++) {
        var r = g_doc_js.lst[i];
        r.selected && lst.push(r);
    }
    return lst;
}

function doc_print() {
    var lst = get_selected_docs();
    var sc_ids = [];
    for(var i = 0; i < lst.length; i++) {
        var r = lst[i];
        sc_ids.push(r.sc_id);
    }
    if(!sc_ids.length) return;
    window.open('?fn=print&auto_print=1&sc_ids=' + sc_ids.join('|'),'posx_batch_print','location=0');
}

function doc_accept() {
    var lst = get_selected_docs();
    var sc_ids = [];
    for(var i = 0; i < lst.length; i++) {
        var r = lst[i];
        if(!(r.sc_flag & ${REC_FLAG_ACCEPTED})) sc_ids.push(r.sc_id);
    }
    if(!sc_ids.length) return;
                
    post_js_ex('?fn=accept', {sc_ids: sc_ids.join('|')}, function(js) {
        if(js.i_warning_s) MsgBox('Warning', js.i_warning_s);
            load_doc_lst(${dt}, -1, 0);
    });
                
}
        
function doc_accept_print() {
    var lst = get_selected_docs();
    var sc_ids = [];
    for(var i = 0; i < lst.length; i++) {
        var r = lst[i];
        if(!(r.sc_flag & ${REC_FLAG_ACCEPTED})) sc_ids.push(r.sc_id);
    }
    if(!sc_ids.length) return;
    
    post_js_ex('?fn=accept', {sc_ids: sc_ids.join('|')}, function(js) {
        if(js.i_warning_s) MsgBox('Warning', js.i_warning_s);
        load_doc_lst(${dt}, -1, 0);
        window.open('?fn=print&auto_print=1&sc_ids=' + sc_ids.join('|'),'posx_batch_print','location=0');
    }, undefined, 1);
    
}

$(function() {

$('#doc_ctrl >select.ctrl_action').change(function() {
    var v = parseInt( $(this).val() ) || 0;
    $(this).val('');
    
    if(v === 1)
        doc_print();
    else if (v === 2)
        doc_accept();
    else
        doc_accept_print();
        
});

g_v_doc_filter = $('#doc_ctrl >select.ctrl_filter').change(function() { load_doc_lst(${dt}, -1, 0); });

g_v_dlg_view_doc = $('#dlg_view_doc').dialog({
    autoOpen: false,
    width:730,
    height:600,
});
g_v_doc_wnd = g_v_dlg_view_doc.children('iframe');

g_v_doc_lst = $('.doc_lst >.prntbl_cnt');
$('.doc_lst >.prntbl_row_hdr input[type="checkbox"]').change(function() {
    if(!g_doc_js) return;
    g_doc_js.v_cbs.prop('checked', $(this).prop('checked')).change();
});
g_v_doc_lst_ftr = $('.doc_lst >.prntbl_row_ftr >div');

g_map = new google.maps.Map(document.getElementById("map_canvas"),
                            {center: new google.maps.LatLng(37.751807, -122.438883), zoom:13}
        );

$(document).keydown(function(e){ g_ctrl_down = e.ctrlKey; }).keyup(function(e){ g_ctrl_down = e.ctrlKey; });

load_doc_lst(${dt}, -1, 0);

});

</script>
    

<style type="text/css">
.ui-widget {font-size:18px;}

#doc_ctrl {position:absolute;top:0;width:420px;height:32px;left:0;padding:9px 5px}
#doc_lst {position:absolute;top:50px;width:430px;bottom:0;left:0;}
#map_canvas {position:absolute;top:0;right:0;bottom:0;left:430px;}

.doc_lst {top:0;bottom:0;left:0;right:0;overflow:hidden}
.doc_lst .prntbl_row {min-width:1000px}
.doc_lst .prntbl_cnt {overflow-x:hidden}
.doc_lst .prntbl_row >div:nth-child(1) {width:20px;}
.doc_lst .prntbl_row >div:nth-child(2) {width:30px;font-weight:bold}
.doc_lst .prntbl_row >div:nth-child(3) {width:70px;cursor:pointer}
.doc_lst .prntbl_row >div:nth-child(4) {width:170px;cursor:pointer}
.doc_lst .prntbl_row >div:nth-child(5) {width:90px}
.doc_lst .prntbl_row >div:nth-child(6) {width:19px;font-weight:bold}
.doc_lst .prntbl_cnt .prntbl_row >div:nth-child(3) {color:#fff}
.doc_lst .prntbl_row_ftr >div:nth-child(1) {width:296px}
.doc_lst .prntbl_row_ftr >div:nth-child(2) {width:130px}

.doc_lst .doc_pending >div:nth-child(3) {background-color:rgb(242,130,91);}
.doc_lst .doc_accepted >div:nth-child(3) {background-color:#627d4d;}
.doc_lst .doc_cancelling >div:nth-child(3) {background-color:#ff3019;}
.doc_lst .doc_changed >div:nth-child(3) {background-color:#903815;}
.doc_lst .doc_rescheduled >div:nth-child(3) {background-color:#3578b5;}
.doc_lst .doc_in_delivery_log {background-color:#cfe0c5}

#dlg_view_doc {position:relative}
#dlg_view_doc > iframe {border:0;margin:0;padding:0;position:absolute;top:0;left:0;width:100%;height:100%;}

</style>

</head>
<body>
<div id="doc_ctrl">
<select class="ctrl_filter" style="width:140px"><option value="">All Docs</option><option value="1">Pending Only</option></select>
%if has_perm_delivery_mgr:
<select class="ctrl_action" style="width:120px"><option value="">- Action -</option><option value="1">打印</option><option value="2">接受</option><option value="3">接受 & 打印</option></select>
%endif
</div>
<div id="doc_lst">
<div class="prntbl doc_lst">
<div class="prntbl_row prntbl_row_hdr"><div><input type="checkbox" /></div><div>#</div><div>Num</div><div>Company</div><div>Amount</div><div>F</div></div>
<div class="prntbl_cnt"></div>
<div class="prntbl_row prntbl_row_ftr"><div></div><div></div></div>
</div>
</div>
<div id="map_canvas"></div>

<div id="dlg_view_doc"><iframe></iframe></div>

</body>
</html>
